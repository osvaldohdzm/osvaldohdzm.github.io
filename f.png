example 21

PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVzIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8dGl0bGU+QXVkaW9MaW5rIFByb3RvY29sIHYzLjA8L3RpdGxlPgogICAgPHN0eWxlPgogICAgICAgIDpyb290IHsgLS1iZzogIzBkMTExNzsgLS1wYW5lbDogIzE2MWIyMjsgLS1hY2NlbnQ6ICMyMzg2MzY7IC0tdGV4dDogI2M5ZDFkOTsgLS1lcnI6ICNkYTM2MzM7IH0KICAgICAgICBib2R5IHsgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsgYmFja2dyb3VuZDogdmFyKC0tYmcpOyBjb2xvcjogdmFyKC0tdGV4dCk7IHBhZGRpbmc6IDIwcHg7IGRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IGFsaWduLWl0ZW1zOiBjZW50ZXI7IH0KICAgICAgICAuY29udGFpbmVyIHsgZGlzcGxheTogZmxleDsgZmxleC13cmFwOiB3cmFwOyBnYXA6IDIwcHg7IHdpZHRoOiAxMDAlOyBtYXgtd2lkdGg6IDkwMHB4OyB9CiAgICAgICAgLmNhcmQgeyBmbGV4OiAxOyBiYWNrZ3JvdW5kOiB2YXIoLS1wYW5lbCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDZweDsgYm9yZGVyOiAxcHggc29saWQgIzMwMzYzZDsgbWluLXdpZHRoOiAzMDBweDsgfQogICAgICAgIGgyIHsgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICMzMDM2M2Q7IHBhZGRpbmctYm90dG9tOiAxMHB4OyBtYXJnaW4tdG9wOiAwOyBjb2xvcjogIzU4YTZmZjsgfQogICAgICAgIAogICAgICAgIC8qIFVJIEVsZW1lbnRzICovCiAgICAgICAgaW5wdXRbdHlwZT0iZmlsZSJdIHsgbWFyZ2luLWJvdHRvbTogMTVweDsgd2lkdGg6IDEwMCU7IH0KICAgICAgICBidXR0b24geyB3aWR0aDogMTAwJTsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogIzIxMjYyZDsgYm9yZGVyOiAxcHggc29saWQgIzMwMzYzZDsgY29sb3I6IHdoaXRlOyBjdXJzb3I6IHBvaW50ZXI7IGJvcmRlci1yYWRpdXM6IDRweDsgZm9udC13ZWlnaHQ6IGJvbGQ7IHRyYW5zaXRpb246IDAuMnM7IH0KICAgICAgICBidXR0b246aG92ZXIgeyBiYWNrZ3JvdW5kOiAjMzAzNjNkOyBib3JkZXItY29sb3I6ICM4Yjk0OWU7IH0KICAgICAgICBidXR0b24uYWN0aXZlIHsgYmFja2dyb3VuZDogdmFyKC0tYWNjZW50KTsgYm9yZGVyLWNvbG9yOiB2YXIoLS1hY2NlbnQpOyB9CiAgICAgICAgCiAgICAgICAgLyogVmlzdWFsaXphY2nDs24gKi8KICAgICAgICBjYW52YXMgeyB3aWR0aDogMTAwJTsgaGVpZ2h0OiA4MHB4OyBiYWNrZ3JvdW5kOiAjMDAwOyBtYXJnaW4tdG9wOiAxNXB4OyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICMzMDM2M2Q7IH0KICAgICAgICAudGVybWluYWwgeyBiYWNrZ3JvdW5kOiAjMDAwOyBoZWlnaHQ6IDE1MHB4OyBvdmVyZmxvdy15OiBhdXRvOyBwYWRkaW5nOiAxMHB4OyBmb250LXNpemU6IDExcHg7IG1hcmdpbi10b3A6IDE1cHg7IGJvcmRlcjogMXB4IHNvbGlkICMzMDM2M2Q7IGNvbG9yOiAjN2VlNzg3OyB9CiAgICAgICAgCiAgICAgICAgLyogUHJvZ3Jlc28gKi8KICAgICAgICAubWV0YS1pbmZvIHsgYmFja2dyb3VuZDogIzIxMjYyZDsgcGFkZGluZzogMTBweDsgbWFyZ2luLXRvcDogMTBweDsgYm9yZGVyLXJhZGl1czogNHB4OyBmb250LXNpemU6IDAuOWVtOyBkaXNwbGF5OiBub25lOyB9CiAgICAgICAgLnByb2dyZXNzLWNvbnRhaW5lciB7IGhlaWdodDogMjBweDsgYmFja2dyb3VuZDogIzMwMzYzZDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luLXRvcDogMTBweDsgb3ZlcmZsb3c6IGhpZGRlbjsgcG9zaXRpb246IHJlbGF0aXZlOyB9CiAgICAgICAgLnByb2dyZXNzLWJhciB7IGhlaWdodDogMTAwJTsgYmFja2dyb3VuZDogdmFyKC0tYWNjZW50KTsgd2lkdGg6IDAlOyB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzIGxpbmVhcjsgfQogICAgICAgIC5wYWNrZXQtZ3JpZCB7IGRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZmlsbCwgbWlubWF4KDhweCwgMWZyKSk7IGdhcDogMXB4OyBtYXJnaW4tdG9wOiAxMHB4OyBoZWlnaHQ6IDUwcHg7IG92ZXJmbG93OiBoaWRkZW47IH0KICAgICAgICAucGt0IHsgaGVpZ2h0OiA4cHg7IGJhY2tncm91bmQ6ICMzMzM7IH0KICAgICAgICAucGt0Lm9rIHsgYmFja2dyb3VuZDogdmFyKC0tYWNjZW50KTsgfQogICAgICAgIC5wa3QuYmFkIHsgYmFja2dyb3VuZDogdmFyKC0tZXJyKTsgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KCjxoMT7wn5SKIEF1ZGlvTGluayBQcm90b2NvbCA8c21hbGw+djMuMDwvc21hbGw+PC9oMT4KCjxkaXYgY2xhc3M9ImNvbnRhaW5lciI+CiAgICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgICAgICA8aDI+8J+ToSBFbWlzb3IgKFR4KTwvaDI+CiAgICAgICAgPGlucHV0IHR5cGU9ImZpbGUiIGlkPSJpbkZpbGUiPgogICAgICAgIDxkaXYgaWQ9ImZpbGVEZXRhaWxzIiBzdHlsZT0iZm9udC1zaXplOiAwLjhlbTsgbWFyZ2luLWJvdHRvbTogMTBweDsgY29sb3I6ICM4Yjk0OWU7Ij48L2Rpdj4KICAgICAgICA8YnV0dG9uIGlkPSJidG5TZW5kIj5JbmljaWFyIFRyYW5zbWlzacOzbjwvYnV0dG9uPgogICAgICAgIDxkaXYgY2xhc3M9InRlcm1pbmFsIiBpZD0idGVybVR4Ij4+IFNpc3RlbWEgbGlzdG8uLi48L2Rpdj4KICAgIDwvZGl2PgoKICAgIDxkaXYgY2xhc3M9ImNhcmQiPgogICAgICAgIDxoMj7wn46nIFJlY2VwdG9yIChSeCk8L2gyPgogICAgICAgIDxidXR0b24gaWQ9ImJ0blJlYyI+QWN0aXZhciBFc2N1Y2hhPC9idXR0b24+CiAgICAgICAgPGNhbnZhcyBpZD0ic2NvcGUiPjwvY2FudmFzPgogICAgICAgIAogICAgICAgIDxkaXYgaWQ9InJ4TWV0YSIgY2xhc3M9Im1ldGEtaW5mbyI+CiAgICAgICAgICAgIDxzdHJvbmc+UmVjaWJpZW5kbzo8L3N0cm9uZz4gPHNwYW4gaWQ9InJ4RmlsZU5hbWUiPi0tLTwvc3Bhbj48YnI+CiAgICAgICAgICAgIDxzdHJvbmc+VGFtYcOxbzo8L3N0cm9uZz4gPHNwYW4gaWQ9InJ4RmlsZVNpemUiPjA8L3NwYW4+IGJ5dGVzPGJyPgogICAgICAgICAgICA8c3Ryb25nPlBhcXVldGVzOjwvc3Ryb25nPiA8c3BhbiBpZD0icnhQYWNrZXRzIj4wLzA8L3NwYW4+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDxkaXYgY2xhc3M9InByb2dyZXNzLWNvbnRhaW5lciI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2dyZXNzLWJhciIgaWQ9InJ4QmFyIj48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8ZGl2IGNsYXNzPSJwYWNrZXQtZ3JpZCIgaWQ9InBrdEdyaWQiPjwvZGl2PgogICAgICAgIDxkaXYgaWQ9ImRvd25sb2FkTGluayIgc3R5bGU9Im1hcmdpbi10b3A6MTVweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0idGVybWluYWwiIGlkPSJ0ZXJtUngiPj4gRXNwZXJhbmRvIHNlw7FhbC4uLjwvZGl2PgogICAgPC9kaXY+CjwvZGl2PgoKPHNjcmlwdD4KICAgIC8qIC0tLSBDT05GSUdVUkFDScOTTiBERUwgUFJPVE9DT0xPIEbDjVNJQ08gLS0tICovCiAgICBjb25zdCBQUk9UT0NPTCA9IHsKICAgICAgICBmcmVxX21hcms6IDIwMDAsICAgIC8vIEZyZWN1ZW5jaWEgYmFzZQogICAgICAgIHNoaWZ0OiAxMDAsICAgICAgICAgLy8gRGVzcGxhemFtaWVudG8gZW50cmUgdG9ub3MKICAgICAgICBiYXVkOiAyMCwgICAgICAgICAgIC8vIFZlbG9jaWRhZCAoQmFqYXIgc2kgaGF5IG11Y2hvIGVycm9yLCBzdWJpciBwYXJhIHZlbG9jaWRhZCkKICAgICAgICBzdGFydF90b2tlbjogWzEsMCwxLDAsMSwxLDAsMF0sIC8vIEJ5dGUgZGUgc2luY3Jvbml6YWNpw7NuICgweEFDKQogICAgICAgIGhlYWRlcl9pZDogICBbMSwxLDEsMSwwLDAsMCwwXSAgLy8gQnl0ZSBpZGVudGlmaWNhZG9yIGRlIGNhYmVjZXJhICgweEYwKQogICAgfTsKCiAgICAvLyBNYXBlbyBkZSA0IGJpdHMgYSAxNiBmcmVjdWVuY2lhcyAoMTYtRlNLIHNpbXBsaWZpY2FkbyBwYXJhIGVzdGEgZGVtbyB1c2Ftb3MgYmluYXJpbyByb2J1c3RvKQogICAgLy8gUGFyYSBtw6F4aW1hIHJvYnVzdGV6IGVuIEpTLCB1c2FyZW1vcyBCRlNLIChCaW5hcnkgRlNLKSBsZW50byBwZXJvIHNlZ3Vyby4KICAgIC8vIDAgPSAxNTAwSHosIDEgPSAyNTAwSHouCiAgICBjb25zdCBGUkVRXzAgPSAxODAwOwogICAgY29uc3QgRlJFUV8xID0gMjgwMDsKCiAgICAvLyBVdGlsaWRhZGVzIGRlIFVJCiAgICBjb25zdCBsb2cgPSAoaWQsIG1zZykgPT4gewogICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgIGVsLmlubmVySFRNTCArPSBgPGRpdj4ke21zZ308L2Rpdj5gOwogICAgICAgIGVsLnNjcm9sbFRvcCA9IGVsLnNjcm9sbEhlaWdodDsKICAgIH07CgogICAgLy8gLS0tIEzDk0dJQ0EgREVMIEVNSVNPUiAoVHgpIC0tLQogICAgCiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5GaWxlJykuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsKICAgICAgICBjb25zdCBmaWxlID0gZS50YXJnZXQuZmlsZXNbMF07CiAgICAgICAgaWYoZmlsZSkgewogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsZURldGFpbHMnKS5pbm5lclRleHQgPSBgJHtmaWxlLm5hbWV9ICgke2ZpbGUuc2l6ZX0gYnl0ZXMpYDsKICAgICAgICB9CiAgICB9KTsKCiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuU2VuZCcpLm9uY2xpY2sgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgY29uc3QgZmlsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbkZpbGUnKS5maWxlc1swXTsKICAgICAgICBpZighZmlsZSkgcmV0dXJuIGFsZXJ0KCJTZWxlY2Npb25hIHVuIGFyY2hpdm8iKTsKCiAgICAgICAgY29uc3QgYXVkaW9DdHggPSBuZXcgKHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dCkoKTsKICAgICAgICBsb2coJ3Rlcm1UeCcsIGBQcmVwYXJhbmRvICR7ZmlsZS5uYW1lfS4uLmApOwoKICAgICAgICAvLyAxLiBDcmVhciBQQVFVRVRFIERFIENBQkVDRVJBIChIYW5kc2hha2UpCiAgICAgICAgLy8gRm9ybWF0byBKU09OIHNpbXBsZSBwYXJhIG1ldGFkYXRvczoge246Im5vbWJyZSIsIHM6Ynl0ZXN9CiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBKU09OLnN0cmluZ2lmeSh7IG46IGZpbGUubmFtZSwgczogZmlsZS5zaXplIH0pOwogICAgICAgIGNvbnN0IGhlYWRlckJ5dGVzID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKG1ldGFkYXRhKTsKICAgICAgICAKICAgICAgICAvLyAyLiBMZWVyIGFyY2hpdm8KICAgICAgICBjb25zdCBmaWxlQnVmZmVyID0gYXdhaXQgZmlsZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIGNvbnN0IGZpbGVCeXRlcyA9IG5ldyBVaW50OEFycmF5KGZpbGVCdWZmZXIpOwoKICAgICAgICAvLyAzLiBTZWN1ZW5jaWEgZGUgdHJhbnNtaXNpw7NuIGNvbXBsZXRhCiAgICAgICAgLy8gW1BSRUFNQlVMT10gKyBbVElQTzogSEVBREVSXSArIFtMRU5dICsgW0pTT05dICsgW0NSQ10gLi4uIHBhdXNhIC4uLiBbREFUT1NdCiAgICAgICAgCiAgICAgICAgbG9nKCd0ZXJtVHgnLCAiRW1pdGllbmRvIHNlw7FhbCBkZSBzaW5jcm9uaXphY2nDs24uLi4iKTsKICAgICAgICBhd2FpdCBiZWVwKGF1ZGlvQ3R4LCA0NDAsIDEpOyAvLyBUb25vIHBpbG90bwogICAgICAgIAogICAgICAgIGxvZygndGVybVR4JywgIkVudmlhbmRvIGNhYmVjZXJhIChOb21icmUvVGFtYcOxbykuLi4iKTsKICAgICAgICAvLyBDb252ZXJ0aW1vcyBhIGJpdHMgbGEgY2FiZWNlcmEKICAgICAgICBhd2FpdCB0cmFuc21pdEJ5dGVzKGF1ZGlvQ3R4LCBoZWFkZXJCeXRlcywgdHJ1ZSk7IC8vIHRydWUgPSBlcyBjYWJlY2VyYQoKICAgICAgICBsb2coJ3Rlcm1UeCcsICJQYXVzYSB0w6ljbmljYSAoMXMpLi4uIik7CiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDEwMDApKTsKCiAgICAgICAgbG9nKCd0ZXJtVHgnLCAiRW52aWFuZG8gY3VlcnBvIGRlbCBhcmNoaXZvLi4uIik7CiAgICAgICAgYXdhaXQgdHJhbnNtaXRCeXRlcyhhdWRpb0N0eCwgZmlsZUJ5dGVzLCBmYWxzZSk7IC8vIGZhbHNlID0gZXMgY3VlcnBvCgogICAgICAgIGxvZygndGVybVR4JywgIuKchSBUcmFuc21pc2nDs24gZmluYWxpemFkYS4iKTsKICAgICAgICBiZWVwKGF1ZGlvQ3R4LCA4ODAsIDAuNSk7IC8vIFRvbm8gZmluYWwKICAgIH07CgogICAgYXN5bmMgZnVuY3Rpb24gdHJhbnNtaXRCeXRlcyhjdHgsIHVpbnQ4QXJyYXksIGlzSGVhZGVyKSB7CiAgICAgICAgLy8gRW52b2x2ZXIgZGF0b3MgZW4gdW5hIGVzdHJ1Y3R1cmEgc2ltcGxlOiBbU1RBUlRfQllURV0gKyBbREFUQV0KICAgICAgICAvLyBQYXJhIHJvYnVzdGV6LCBlbnZpYW1vcyBieXRlIGEgYnl0ZSBjb24gYml0IGRlIHBhcmlkYWQgbyBDUkMgc2ltcGxlCiAgICAgICAgCiAgICAgICAgY29uc3QgYml0RHVyYXRpb24gPSAxIC8gUFJPVE9DT0wuYmF1ZDsKICAgICAgICBjb25zdCBvc2MgPSBjdHguY3JlYXRlT3NjaWxsYXRvcigpOwogICAgICAgIGNvbnN0IGdhaW4gPSBjdHguY3JlYXRlR2FpbigpOwogICAgICAgIG9zYy5jb25uZWN0KGdhaW4pOwogICAgICAgIGdhaW4uY29ubmVjdChjdHguZGVzdGluYXRpb24pOwogICAgICAgIG9zYy5zdGFydCgpOwoKICAgICAgICAvLyBGdW5jacOzbiBhdXhpbGlhciBwYXJhIGVtaXRpciBiaXRzCiAgICAgICAgY29uc3QgcGxheUJpdCA9IChiaXQsIHRpbWUpID0+IHsKICAgICAgICAgICAgb3NjLmZyZXF1ZW5jeS5zZXRWYWx1ZUF0VGltZShiaXQgPT09ICcxJyA/IEZSRVFfMSA6IEZSRVFfMCwgdGltZSk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IHN0YXJ0VGltZSA9IGN0eC5jdXJyZW50VGltZSArIDAuMTsKICAgICAgICAKICAgICAgICAvLyBQcmXDoW1idWxvIGVzcGVjaWFsIHNpIGVzIEhlYWRlcgogICAgICAgIGxldCBiaXRTdHJlYW0gPSAiIjsKICAgICAgICAKICAgICAgICAvLyBDb252ZXJ0aXIgY2FkYSBieXRlIGEgYmluYXJpbwogICAgICAgIGZvcihsZXQgYnl0ZSBvZiB1aW50OEFycmF5KSB7CiAgICAgICAgICAgIGJpdFN0cmVhbSArPSBieXRlLnRvU3RyaW5nKDIpLnBhZFN0YXJ0KDgsICcwJyk7CiAgICAgICAgfQoKICAgICAgICAvLyBTaSBlcyBoZWFkZXIsIGFncmVnYW1vcyB1biBwcmVmaWpvIGNvbm9jaWRvICIxMDEwMTAxMCIgeCAyCiAgICAgICAgbGV0IGZ1bGxTdHJlYW0gPSAoaXNIZWFkZXIgPyAiMTAxMDEwMTAxMTExMTExMSIgOiAiIikgKyBiaXRTdHJlYW07CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnVsbFN0cmVhbS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBwbGF5Qml0KGZ1bGxTdHJlYW1baV0sIHN0YXJ0VGltZSArIChpICogYml0RHVyYXRpb24pKTsKICAgICAgICB9CgogICAgICAgIC8vIERldGVuZXIgb3NjaWxhZG9yIGFsIGZpbmFsCiAgICAgICAgY29uc3QgdG90YWxEdXJhdGlvbiA9IGZ1bGxTdHJlYW0ubGVuZ3RoICogYml0RHVyYXRpb247CiAgICAgICAgb3NjLnN0b3Aoc3RhcnRUaW1lICsgdG90YWxEdXJhdGlvbik7CiAgICAgICAgCiAgICAgICAgLy8gRXNwZXJhciBhIHF1ZSB0ZXJtaW5lIEpTCiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCB0b3RhbER1cmF0aW9uICogMTAwMCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGJlZXAoY3R4LCBmcmVxLCBkdXIpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UociA9PiB7CiAgICAgICAgICAgIGNvbnN0IG8gPSBjdHguY3JlYXRlT3NjaWxsYXRvcigpOwogICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgby5mcmVxdWVuY3kudmFsdWUgPSBmcmVxOwogICAgICAgICAgICBvLmNvbm5lY3QoZyk7CiAgICAgICAgICAgIGcuY29ubmVjdChjdHguZGVzdGluYXRpb24pOwogICAgICAgICAgICBvLnN0YXJ0KCk7CiAgICAgICAgICAgIG8uc3RvcChjdHguY3VycmVudFRpbWUgKyBkdXIpOwogICAgICAgICAgICBzZXRUaW1lb3V0KHIsIGR1cioxMDAwKTsKICAgICAgICB9KTsKICAgIH0KCgogICAgLy8gLS0tIEzDk0dJQ0EgREVMIFJFQ0VQVE9SIChSeCkgLS0tCiAgICAKICAgIGxldCByeEJ1ZmZlciA9IFtdOyAvLyBCdWZmZXIgcGFyYSBiaXRzCiAgICBsZXQgcnhTdGF0ZSA9ICJJRExFIjsgLy8gSURMRSwgSEVBREVSLCBEQVRBCiAgICBsZXQgZGV0ZWN0ZWRGaWxlID0geyBuYW1lOiAiIiwgc2l6ZTogMCwgYml0c1JlY2VpdmVkOiAwIH07CiAgICAKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5SZWMnKS5vbmNsaWNrID0gYXN5bmMgKCkgPT4gewogICAgICAgIGNvbnN0IGF1ZGlvQ3R4ID0gbmV3ICh3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQpKCk7CiAgICAgICAgY29uc3Qgc3RyZWFtID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoeyBhdWRpbzogeyBlY2hvQ2FuY2VsbGF0aW9uOiBmYWxzZSwgbm9pc2VTdXBwcmVzc2lvbjogZmFsc2UgfSB9KTsKICAgICAgICBjb25zdCBzb3VyY2UgPSBhdWRpb0N0eC5jcmVhdGVNZWRpYVN0cmVhbVNvdXJjZShzdHJlYW0pOwogICAgICAgIGNvbnN0IGFuYWx5c2VyID0gYXVkaW9DdHguY3JlYXRlQW5hbHlzZXIoKTsKICAgICAgICBhbmFseXNlci5mZnRTaXplID0gMTAyNDsKICAgICAgICBzb3VyY2UuY29ubmVjdChhbmFseXNlcik7CgogICAgICAgIGRyYXdTY29wZShhbmFseXNlcik7IC8vIFZpc3VhbGl6YWRvcgogICAgICAgIHN0YXJ0RGVtb2R1bGF0aW9uKGFuYWx5c2VyLCBhdWRpb0N0eCk7CiAgICAgICAgCiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0blJlYycpLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUmVjJykuaW5uZXJUZXh0ID0gIkVzY3VjaGFuZG8uLi4iOwogICAgfTsKCiAgICAvLyAtLS0gTU9UT1IgREUgREVNT0RVTEFDScOTTiAtLS0KICAgIGZ1bmN0aW9uIHN0YXJ0RGVtb2R1bGF0aW9uKGFuYWx5c2VyLCBjdHgpIHsKICAgICAgICBjb25zdCBidWZmZXJMZW5ndGggPSBhbmFseXNlci5mcmVxdWVuY3lCaW5Db3VudDsKICAgICAgICBjb25zdCBkYXRhQXJyYXkgPSBuZXcgVWludDhBcnJheShidWZmZXJMZW5ndGgpOwogICAgICAgIAogICAgICAgIGxldCBzaWduYWxIaXN0b3J5ID0gW107CiAgICAgICAgY29uc3Qgc2FtcGxlUmF0ZSA9IGN0eC5zYW1wbGVSYXRlOwogICAgICAgIGNvbnN0IGJpdFRpbWUgPSAxMDAwIC8gUFJPVE9DT0wuYmF1ZDsgLy8gbXMgcG9yIGJpdAogICAgICAgIAogICAgICAgIGxldCBsYXN0Qml0ID0gbnVsbDsKICAgICAgICBsZXQgc2FtZUJpdENvdW50ID0gMDsKICAgICAgICBsZXQgY29sbGVjdGVkQml0cyA9ICIiOwogICAgICAgIAogICAgICAgIC8vIEludGVydmFsbyBkZSBtdWVzdHJlbyBzaW5jcm9uaXphZG8gKFBvbGxpbmcpCiAgICAgICAgLy8gUGFyYSBtYXlvciBwcmVjaXNpw7NuIHNlIGRlYmVyw61hIHVzYXIgU2NyaXB0UHJvY2Vzc29yLCBwZXJvIHNldEludGVydmFsIGVzIG3DoXMgZsOhY2lsIGRlIGVudGVuZGVyCiAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAgICAgICBhbmFseXNlci5nZXRCeXRlRnJlcXVlbmN5RGF0YShkYXRhQXJyYXkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnVzY2FyIHBpY28KICAgICAgICAgICAgbGV0IG1heFZhbCA9IDA7IGxldCBtYXhJZHggPSAwOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxidWZmZXJMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYoZGF0YUFycmF5W2ldID4gbWF4VmFsKSB7IG1heFZhbCA9IGRhdGFBcnJheVtpXTsgbWF4SWR4ID0gaTsgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBmcmVxID0gbWF4SWR4ICogc2FtcGxlUmF0ZSAvIGFuYWx5c2VyLmZmdFNpemU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEZWNpc2nDs24gZGUgYml0IChVbWJyYWwgZGUgZW5lcmfDrWEgPiA1MCkKICAgICAgICAgICAgaWYobWF4VmFsID4gNTApIHsKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50Qml0ID0gIj8iOwogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGZyZXEgLSBGUkVRXzEpIDwgMjAwKSBjdXJyZW50Qml0ID0gIjEiOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoTWF0aC5hYnMoZnJlcSAtIEZSRVFfMCkgPCAyMDApIGN1cnJlbnRCaXQgPSAiMCI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Qml0ICE9PSAiPyIpIHsKICAgICAgICAgICAgICAgICAgIHByb2Nlc3NJbmNvbWluZ0JpdChjdXJyZW50Qml0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sIGJpdFRpbWUpOyAvLyBNdWVzdHJlYW1vcyAxIHZleiBwb3IgInRpZW1wbyBkZSBiaXQiIChNdXkgc2ltcGxlLCBwcm9wZW5zbyBhIGVycm9yZXMgZGUgZmFzZSkKICAgIH0KCiAgICAvLyAtLS0gUFJPQ0VTQURPUiBERSBFU1RBRE9TIChQcm90b2NvbCBMb2dpYykgLS0tCiAgICAKICAgIC8vIE5PVEE6IEVzdGEgZXMgdW5hIGltcGxlbWVudGFjacOzbiBzaW1wbGlmaWNhZGEuIAogICAgLy8gRW4gbGEgcmVhbGlkYWQsIHNlIHJlcXVpZXJlIE92ZXJzYW1wbGluZyAobXVlc3RyZWFyIDQgdmVjZXMgcG9yIGJpdCkgcGFyYSBzaW5jcm9uaXphci4KICAgIC8vIEFxdcOtIGFjdW11bGFtb3MgYml0cyB5IGJ1c2NhbW9zIHBhdHJvbmVzLgogICAgCiAgICBsZXQgYml0U3RyZWFtQnVmZmVyID0gIiI7CiAgICAKICAgIGZ1bmN0aW9uIHByb2Nlc3NJbmNvbWluZ0JpdChiaXQpIHsKICAgICAgICBiaXRTdHJlYW1CdWZmZXIgKz0gYml0OwogICAgICAgIAogICAgICAgIC8vIExpbWl0YXIgYnVmZmVyCiAgICAgICAgaWYoYml0U3RyZWFtQnVmZmVyLmxlbmd0aCA+IDEwMDAwMDApIGJpdFN0cmVhbUJ1ZmZlciA9IGJpdFN0cmVhbUJ1ZmZlci5zbGljZSgtMTAwMCk7CgogICAgICAgIC8vIE3DgVFVSU5BIERFIEVTVEFET1MKICAgICAgICBpZiAocnhTdGF0ZSA9PT0gIklETEUiKSB7CiAgICAgICAgICAgIC8vIEJ1c2NhbW9zIHByZcOhbWJ1bG8gZGUgY2FiZWNlcmE6IDEwMTAxMDEwMTExMTExMTEgKDB4QUEgKyAweEZGKQogICAgICAgICAgICBpZiAoYml0U3RyZWFtQnVmZmVyLmVuZHNXaXRoKCIxMDEwMTAxMDExMTExMTExIikpIHsKICAgICAgICAgICAgICAgIHJ4U3RhdGUgPSAiUkVBRElOR19IRUFERVIiOwogICAgICAgICAgICAgICAgYml0U3RyZWFtQnVmZmVyID0gIiI7IC8vIExpbXBpYXIgcGFyYSBlbXBlemFyIGEgbGVlciBwYXlsb2FkCiAgICAgICAgICAgICAgICBsb2coJ3Rlcm1SeCcsICLwn5SEIFNlw7FhbCBkZSBjYWJlY2VyYSBkZXRlY3RhZGEuIFNpbmNyb25pemFuZG8uLi4iKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyeE1ldGEnKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0gCiAgICAgICAgZWxzZSBpZiAocnhTdGF0ZSA9PT0gIlJFQURJTkdfSEVBREVSIikgewogICAgICAgICAgICAvLyBJbnRlbnRhbW9zIGRlY29kaWZpY2FyIGNhZGEgOCBiaXRzCiAgICAgICAgICAgIGlmIChiaXRTdHJlYW1CdWZmZXIubGVuZ3RoICUgOCA9PT0gMCAmJiBiaXRTdHJlYW1CdWZmZXIubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IGJpdHNUb1RleHQoYml0U3RyZWFtQnVmZmVyKTsKICAgICAgICAgICAgICAgIC8vIFNpIGVuY29udHJhbW9zIHVuIGNpZXJyZSBkZSBKU09OICJ9IiBhc3VtaW1vcyBmaW4gZGUgaGVhZGVyCiAgICAgICAgICAgICAgICBpZiAodGV4dC5pbmNsdWRlcygifSIpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QganNvblN0ciA9IHRleHQuc3Vic3RyaW5nKDAsIHRleHQuaW5kZXhPZigifSIpKzEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXRhID0gSlNPTi5wYXJzZShqc29uU3RyKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGRldGVjdGVkRmlsZS5uYW1lID0gbWV0YS5uOwogICAgICAgICAgICAgICAgICAgICAgICBkZXRlY3RlZEZpbGUuc2l6ZSA9IG1ldGEuczsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFjdHVhbGl6YXIgVUkKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3J4RmlsZU5hbWUnKS5pbm5lclRleHQgPSBtZXRhLm47CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyeEZpbGVTaXplJykuaW5uZXJUZXh0ID0gbWV0YS5zOwogICAgICAgICAgICAgICAgICAgICAgICBsb2coJ3Rlcm1SeCcsIGDwn5OBIE1ldGFkYXRhIHJlY2liaWRhOiAke21ldGEubn1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHJ4U3RhdGUgPSAiV0FJVElOR19EQVRBIjsKICAgICAgICAgICAgICAgICAgICAgICAgYml0U3RyZWFtQnVmZmVyID0gIiI7IC8vIFJlc2V0IHBhcmEgZGF0b3MKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQcO6biBubyBlc3TDoSBjb21wbGV0byBlbCBKU09OLi4uIHNlZ3VpbW9zCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHJ4U3RhdGUgPT09ICJXQUlUSU5HX0RBVEEiKSB7CiAgICAgICAgICAgICAvLyBBcXXDrSBlc3BlcmFyaWFtb3MgdW4gc2lsZW5jaW8geSBsdWVnbyBlbCBmbHVqbyBkZSBkYXRvcwogICAgICAgICAgICAgLy8gUGFyYSBsYSBkZW1vLCBzYWx0YW1vcyBkaXJlY3RvIGEgcmVjaWJpcgogICAgICAgICAgICAgaWYoYml0U3RyZWFtQnVmZmVyLmxlbmd0aCA+IDEwKSByeFN0YXRlID0gIlJFQ0VJVklOR19EQVRBIjsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocnhTdGF0ZSA9PT0gIlJFQ0VJVklOR19EQVRBIikgewogICAgICAgICAgICAvLyBDYWxjdWxhciBwcm9ncmVzbwogICAgICAgICAgICBjb25zdCBiaXRzTmVlZGVkID0gZGV0ZWN0ZWRGaWxlLnNpemUgKiA4OwogICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IE1hdGgubWluKDEwMCwgKGJpdFN0cmVhbUJ1ZmZlci5sZW5ndGggLyBiaXRzTmVlZGVkKSAqIDEwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncnhCYXInKS5zdHlsZS53aWR0aCA9IHByb2dyZXNzICsgIiUiOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncnhQYWNrZXRzJykuaW5uZXJUZXh0ID0gYCR7TWF0aC5mbG9vcihiaXRTdHJlYW1CdWZmZXIubGVuZ3RoLzgpfSAvICR7ZGV0ZWN0ZWRGaWxlLnNpemV9YDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbGl6YWNpw7NuIGRlICJwYXF1ZXRlcyIgKHNpbXVsYWRvcyBwb3IgY2FkYSBieXRlKQogICAgICAgICAgICBpZihiaXRTdHJlYW1CdWZmZXIubGVuZ3RoICUgOCA9PT0gMCkgewogICAgICAgICAgICAgICAgY29uc3QgcEdyaWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGt0R3JpZCcpOwogICAgICAgICAgICAgICAgaWYocEdyaWQuY2hpbGRFbGVtZW50Q291bnQgPCAyMDApIHsgLy8gTm8gc2F0dXJhciBET00KICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICBkaXYuY2xhc3NOYW1lID0gInBrdCBvayI7CiAgICAgICAgICAgICAgICAgICAgcEdyaWQuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJpdFN0cmVhbUJ1ZmZlci5sZW5ndGggPj0gYml0c05lZWRlZCkgewogICAgICAgICAgICAgICAgZmluaXNoUmVjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZmluaXNoUmVjZXB0aW9uKCkgewogICAgICAgIGlmKHJ4U3RhdGUgPT09ICJET05FIikgcmV0dXJuOwogICAgICAgIHJ4U3RhdGUgPSAiRE9ORSI7CiAgICAgICAgbG9nKCd0ZXJtUngnLCAi8J+PgSBEZXNjYXJnYSBjb21wbGV0YS4gUmVjb25zdHJ1eWVuZG8gYXJjaGl2by4uLiIpOwogICAgICAgIAogICAgICAgIC8vIENvbnZlcnRpciBiaXRzIGEgYnl0ZXMKICAgICAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGRldGVjdGVkRmlsZS5zaXplKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxkZXRlY3RlZEZpbGUuc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGJ5dGVTdHIgPSBiaXRTdHJlYW1CdWZmZXIuc3Vic3RyKGkqOCwgOCk7CiAgICAgICAgICAgIGJ5dGVzW2ldID0gcGFyc2VJbnQoYnl0ZVN0ciwgMik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbYnl0ZXNdKTsKICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgIAogICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG93bmxvYWRMaW5rJyk7CiAgICAgICAgbGluay5pbm5lckhUTUwgPSBgPGEgaHJlZj0iJHt1cmx9IiBkb3dubG9hZD0iJHtkZXRlY3RlZEZpbGUubmFtZX0iIHN0eWxlPSJjb2xvcjojN2VlNzg3OyBmb250LXNpemU6MS4yZW07IGZvbnQtd2VpZ2h0OmJvbGQ7Ij7irIfvuI8gR3VhcmRhciAke2RldGVjdGVkRmlsZS5uYW1lfTwvYT5gOwogICAgICAgIAogICAgICAgIC8vIEVmZWN0byB2aXN1YWwKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncnhCYXInKS5zdHlsZS5iYWNrZ3JvdW5kID0gIiMyMzg2MzYiOwogICAgfQoKICAgIC8vIC0tLSBVVElMSURBREVTIC0tLQogICAgZnVuY3Rpb24gYml0c1RvVGV4dChiaXRzKSB7CiAgICAgICAgbGV0IHN0ciA9ICIiOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYml0cy5sZW5ndGg7IGkgKz0gOCkgewogICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludChiaXRzLnN1YnN0cihpLCA4KSwgMikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXdTY29wZShhbmFseXNlcikgewogICAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29wZScpOwogICAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGJ1ZmZlckxlbmd0aCA9IGFuYWx5c2VyLmZyZXF1ZW5jeUJpbkNvdW50OwogICAgICAgIGNvbnN0IGRhdGFBcnJheSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlckxlbmd0aCk7CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZHJhdygpIHsKICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRyYXcpOwogICAgICAgICAgICBhbmFseXNlci5nZXRCeXRlRnJlcXVlbmN5RGF0YShkYXRhQXJyYXkpOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAnOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGJhcldpZHRoID0gKGNhbnZhcy53aWR0aCAvIGJ1ZmZlckxlbmd0aCkgKiAyLjU7CiAgICAgICAgICAgIGxldCB4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGJ1ZmZlckxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYXJIZWlnaHQgPSBkYXRhQXJyYXlbaV0gLyAyOwogICAgICAgICAgICAgICAgLy8gQ29sb3JlYXIgZnJlY3VlbmNpYXMgY2xhdmUKICAgICAgICAgICAgICAgIGNvbnN0IGZyZXEgPSBpICogNDQxMDAgLyAxMDI0OyAvLyBBcHJveAogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGZyZXEgLSBGUkVRXzApIDwgMTAwKSBjdHguZmlsbFN0eWxlID0gJyNkYTM2MzMnOyAvLyBSb2pvICgwKQogICAgICAgICAgICAgICAgZWxzZSBpZiAoTWF0aC5hYnMoZnJlcSAtIEZSRVFfMSkgPCAxMDApIGN0eC5maWxsU3R5bGUgPSAnIzIzODYzNic7IC8vIFZlcmRlICgxKQogICAgICAgICAgICAgICAgZWxzZSBjdHguZmlsbFN0eWxlID0gJyMzMDM2M2QnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoeCwgY2FudmFzLmhlaWdodCAtIGJhckhlaWdodCwgYmFyV2lkdGgsIGJhckhlaWdodCk7CiAgICAgICAgICAgICAgICB4ICs9IGJhcldpZHRoICsgMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBkcmF3KCk7CiAgICB9Cjwvc2NyaXB0PgoKPC9ib2R5Pgo8L2h0bWw+

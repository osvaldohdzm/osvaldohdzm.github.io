<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptor V6 - Diagn√≥stico & Ventanas</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --bg: #050505; --main: #00ff41; --panel: #111; --warn: #ffcc00; }
        * { box-sizing: border-box; }
        
        body { 
            background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; 
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- VISOR --- */
        #media-stage {
            flex: 1; position: relative; background: #000; 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        #reader { width: 100%; height: 100%; display: none; }
        #screen-video { width: 100%; height: 100%; object-fit: contain; display: none; }
        
        /* Overlay Gu√≠a */
        .overlay-guide {
            position: absolute; pointer-events: none; z-index: 10;
            bottom: 20px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px;
            color: var(--main); font-weight: bold; font-size: 0.9rem; border: 1px solid var(--main);
        }

        /* --- CONTROLES --- */
        .controls { 
            background: var(--panel); border-top: 2px solid #333; 
            padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 20;
            max-height: 40vh; overflow-y: auto;
        }

        /* Botones Superiores */
        .btn-group { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer; color: #fff; background: #333;
            transition: 0.2s;
        }
        button:hover { background: #444; }
        .btn-active { background: #003300; border: 1px solid var(--main); color: var(--main); }

        /* Barras */
        .progress-container { height: 15px; background: #222; border-radius: 8px; overflow: hidden; position: relative; }
        .bar { height: 100%; width: 0%; background: var(--main); transition: width 0.3s; }
        
        /* Grid de Info */
        .info { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.8rem; color: #aaa; }
        .info span { color: #fff; font-weight: bold; }

        /* --- DIAGN√ìSTICO (LA MEJORA) --- */
        #diag-panel {
            background: #2a2200; border: 1px dashed var(--warn); padding: 10px; border-radius: 6px;
            display: none; animation: popIn 0.3s;
        }
        .diag-title { color: var(--warn); font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        .diag-data { font-family: monospace; font-size: 1.1rem; color: #fff; background: #000; padding: 5px; display: block; text-align: center; }
        .diag-note { font-size: 0.75rem; color: #ccc; margin-top: 5px; display: block; }

        #btn-dl { background: var(--main); color: #000; display: none; margin-top: 5px; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body onload="setMode('cam')">

<div id="media-stage">
    <div id="reader"></div>
    <video id="screen-video" autoplay playsinline muted></video>
    <div class="overlay-guide" id="guide-text">Selecciona una fuente</div>
</div>

<div class="controls">
    <div class="btn-group">
        <button id="btn-cam" onclick="setMode('cam')">üì∑ C√ÅMARA</button>
        <button id="btn-screen" onclick="setMode('screen')">üíª VENTANA / PANTALLA</button>
    </div>

    <div class="progress-container">
        <div id="bar" class="bar"></div>
    </div>

    <div class="info">
        <div>Bloques: <span id="lbl-parts">0/0</span></div>
        <div>Velocidad: <span id="lbl-speed">0</span> pq/s</div>
    </div>

    <div id="diag-panel">
        <span class="diag-title">‚ö†Ô∏è TRANSFERENCIA INCOMPLETA</span>
        <span class="diag-note">Configura el Emisor con estos valores:</span>
        <span class="diag-data" id="diag-msg">Calculando...</span>
        <button onclick="runDiagnosis()" style="margin-top:5px; background: #443300; border:1px solid #665500;">üîÑ RE-ANALIZAR FALTANTES</button>
    </div>

    <button id="btn-dl" onclick="downloadFile()">GUARDAR ARCHIVO üíæ</button>
</div>

<script>
    let html5QrCode = null;
    let screenStream = null;
    let barcodeDetector = null;
    let loopId = null;

    let session = {
        active: false, total: 0, chunks: [], count: 0, filename: "archivo.bin", 
        lastSpeed: 0, packetsSec: 0, missingMode: false
    };

    // --- MODOS DE ENTRADA ---
    async function setMode(mode) {
        await stopAll();
        
        // UI
        document.getElementById('btn-cam').className = mode === 'cam' ? 'btn-active' : '';
        document.getElementById('btn-screen').className = mode === 'screen' ? 'btn-active' : '';
        
        if (mode === 'cam') {
            document.getElementById('reader').style.display = 'block';
            document.getElementById('guide-text').innerText = "Apunta al c√≥digo QR";
            initCamera();
        } else {
            document.getElementById('screen-video').style.display = 'block';
            document.getElementById('guide-text').innerText = "Selecciona 'Ventana' en el popup";
            initScreen();
        }
    }

    async function stopAll() {
        if(html5QrCode) { await html5QrCode.stop().catch(()=>{}); html5QrCode.clear(); }
        if(screenStream) { screenStream.getTracks().forEach(t => t.stop()); }
        if(loopId) cancelAnimationFrame(loopId);
        document.getElementById('reader').style.display = 'none';
        document.getElementById('screen-video').style.display = 'none';
    }

    // --- MODO C√ÅMARA ---
    async function initCamera() {
        html5QrCode = new Html5Qrcode("reader");
        try {
            await html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 30, qrbox: (w,h)=>({width: w*0.8, height: w*0.8}) },
                processData, 
                ()=>{}
            );
        } catch(e) { alert("Error C√°mara: " + e); }
    }

    // --- MODO PANTALLA (Ventanas de otras apps) ---
    async function initScreen() {
        // Verifica soporte nativo
        if ('BarcodeDetector' in window) {
            barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        } else {
            alert("Aviso: Tu navegador no soporta detecci√≥n acelerada. Usar√° CPU.");
        }

        try {
            // NOTA: Para compartir ventanas de otras apps, el usuario debe elegir "Ventana"
            // en el popup del navegador. No podemos forzarlo por c√≥digo, pero getDisplayMedia lo permite.
            screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" }, // A veces ayuda a compatibilidad
                audio: false
            });
            
            const video = document.getElementById('screen-video');
            video.srcObject = screenStream;

            // Iniciar loop de lectura
            const scan = async () => {
                if(!screenStream.active) return;
                
                if (video.readyState === video.HAVE_ENOUGH_DATA && barcodeDetector) {
                    try {
                        const bitmaps = await barcodeDetector.detect(video);
                        bitmaps.forEach(bmp => processData(bmp.rawValue));
                    } catch(e) {}
                }
                loopId = requestAnimationFrame(scan);
            };
            scan();

        } catch(e) { 
            console.log("Cancelado", e);
            setMode('cam'); 
        }
    }

    // --- L√ìGICA DE DATOS ---
    function processData(text) {
        try {
            const data = JSON.parse(text);

            // 1. Header
            if (data.t === "H" && !session.active) {
                session.active = true;
                session.total = data.c;
                session.filename = data.n;
                session.chunks = new Array(data.c).fill(null);
                document.getElementById('guide-text').innerText = "RECIBIENDO DATOS...";
                return;
            }

            // 2. Chunks
            if (session.active && Array.isArray(data)) {
                const idx = data[0];
                const content = data[1];

                if (session.chunks[idx] === null) {
                    session.chunks[idx] = content;
                    session.count++;
                    session.packetsSec++;
                    updateUI();
                }
            }
        } catch(e) {}
    }

    function updateUI() {
        // Progreso
        const pct = Math.floor((session.count / session.total) * 100);
        document.getElementById('bar').style.width = pct + "%";
        document.getElementById('lbl-parts').innerText = `${session.count} / ${session.total}`;

        // Finalizado
        if (session.count === session.total) {
            document.getElementById('btn-dl').style.display = "block";
            document.getElementById('diag-panel').style.display = "none";
            document.getElementById('guide-text').innerText = "‚úÖ COMPLETADO";
            stopAll();
        }
        
        // Auto-activar diagn√≥stico si estamos estancados al final (ej: >95%)
        if (pct > 90 && !session.missingMode && session.count < session.total) {
            document.getElementById('diag-panel').style.display = "block";
            session.missingMode = true;
            runDiagnosis();
        }
    }

    // --- ALGORITMO DE DIAGN√ìSTICO ---
    window.runDiagnosis = function() {
        if (!session.active) return;

        // Buscar el primer y √∫ltimo bloque faltante
        let firstMissing = -1;
        let lastMissing = -1;
        let missingCount = 0;

        for (let i = 0; i < session.total; i++) {
            if (session.chunks[i] === null) {
                if (firstMissing === -1) firstMissing = i;
                lastMissing = i;
                missingCount++;
            }
        }

        const msgEl = document.getElementById('diag-msg');
        
        if (missingCount === 0) {
            msgEl.innerText = "¬°Todo completo!";
        } else {
            // Sugerir rango
            msgEl.innerHTML = `DESDE: <b style="color:#f00">${firstMissing}</b> <br> HASTA: <b style="color:#f00">${lastMissing}</b>`;
            
            // Feedback vibraci√≥n para avisar al usuario que necesita intervenir
            if(navigator.vibrate) navigator.vibrate(200);
        }
    }

    window.downloadFile = function() {
        const b64Data = session.chunks.join('');
        const blob = new Blob([Uint8Array.from(atob(b64Data), c => c.charCodeAt(0))], {type: "application/octet-stream"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = session.filename;
        link.click();
    }

    // Veloc√≠metro y check de estancamiento
    setInterval(() => {
        document.getElementById('lbl-speed').innerText = session.packetsSec;
        
        // Si la velocidad cae a 0 y nos falta poco, mostrar diagn√≥stico
        if (session.active && session.packetsSec === 0 && session.count > 0 && session.count < session.total) {
            document.getElementById('diag-panel').style.display = "block";
            runDiagnosis();
        }
        session.packetsSec = 0;
    }, 1000);

</script>
</body>
</html>

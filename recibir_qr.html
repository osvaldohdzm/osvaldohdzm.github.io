<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Receptor V3 - Enfoque Mejorado</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --main: #00ff41; --bg: #000; }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden;
        }

        /* √Årea de C√°mara */
        #camera-wrapper {
            position: relative;
            flex: 1;
            background: #111;
            overflow: hidden;
            display: flex; flex-direction: column; justify-content: center;
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        /* Ret√≠cula de ayuda visual para apuntar */
        .overlay-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 280px; height: 280px;
            border: 2px solid rgba(0, 255, 65, 0.3);
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); /* Oscurece el resto */
            pointer-events: none;
            z-index: 10;
        }
        .overlay-guide::after {
            content: "ENCUADRA EL QR AQU√ç";
            position: absolute; bottom: -25px; width: 100%; text-align: center;
            font-size: 0.8rem; color: var(--main); font-weight: bold;
        }

        /* Panel de Control Inferior */
        .controls { 
            height: auto; min-height: 180px; 
            background: #1a1a1a; border-top: 2px solid #333; 
            padding: 15px; display: flex; flex-direction: column; gap: 10px;
            z-index: 20;
        }

        /* Barra Progreso */
        .progress-container {
            height: 20px; background: #333; border-radius: 10px; overflow: hidden; position: relative;
        }
        .progress-bar { height: 100%; width: 0%; background: var(--main); transition: width 0.1s; }
        .progress-text { 
            position: absolute; width: 100%; text-align: center; top: 1px; 
            font-size: 0.75rem; color: #fff; text-shadow: 0 1px 2px #000; font-weight: bold;
        }

        /* Info Grid */
        .info { display: grid; grid-template-columns: 1fr 1fr; font-size: 0.8rem; color: #ccc; gap: 5px; }
        .status-txt { color: yellow; grid-column: span 2; text-align: center; font-weight: bold; margin-bottom: 5px; }

        /* Botones */
        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer;
        }
        .btn-retry { background: #333; color: white; border: 1px solid #555; }
        .btn-dl { background: var(--main); color: black; display: none; }

    </style>
</head>
<body>

<div id="camera-wrapper">
    <div id="reader"></div>
    <div class="overlay-guide"></div>
</div>

<div class="controls">
    <div id="status" class="status-txt">INICIANDO C√ÅMARA...</div>

    <div class="progress-container">
        <div id="bar" class="progress-bar"></div>
        <div id="pct" class="progress-text">0%</div>
    </div>

    <div class="info">
        <div>Archivo: <span id="lbl-name">-</span></div>
        <div>Bloques: <span id="lbl-parts">0/0</span></div>
        <div>Velocidad: <span id="lbl-speed">0</span> pq/s</div>
        <div>Hash: <span id="lbl-hash">-</span></div>
    </div>

    <div class="btn-group">
        <button class="btn-retry" onclick="restartCamera()">RE-ENFOCAR üîÑ</button>
        <button id="btn-dl" class="btn-dl" onclick="downloadFile()">DESCARGAR üíæ</button>
    </div>
</div>

<script>
    let html5QrCode;
    let session = {
        active: false,
        total: 0,
        chunks: [],
        count: 0,
        filename: "archivo.bin",
        packetsSec: 0
    };

    // CONFIGURACI√ìN DE C√ÅMARA AGRESIVA
    // Pedimos alta resoluci√≥n para que el QR denso del Header se vea n√≠tido
    const cameraConfig = { 
        fps: 30, // 30 es suficiente, m√°s puede calentar y laguear el enfoque
        qrbox: function(viewfinderWidth, viewfinderHeight) {
            // Hacemos la caja de escaneo grande (80% del ancho)
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            return {
                width: Math.floor(minEdge * 0.80),
                height: Math.floor(minEdge * 0.80)
            };
        },
        aspectRatio: 1.0 
    };

    function startCamera() {
        html5QrCode = new Html5Qrcode("reader");
        
        // Intentamos forzar la c√°mara trasera con configuraciones avanzadas
        const constraints = { 
            facingMode: "environment",
            focusMode: "continuous", // Importante para Android
            width: { min: 1280, ideal: 1920 }, // Pedir HD ayuda a leer QRs densos
            height: { min: 720, ideal: 1080 } 
        };

        html5QrCode.start(
            constraints, 
            cameraConfig,
            onScanSuccess,
            onScanError
        ).then(() => {
            updateStatus("C√ÅMARA LISTA - ESCANEA HEADER", "#fff");
        }).catch(err => {
            updateStatus("ERROR DE C√ÅMARA: " + err, "red");
        });
    }

    function restartCamera() {
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                console.log("Reiniciando...");
                startCamera();
            }).catch(() => startCamera());
        } else {
            startCamera();
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        try {
            const data = JSON.parse(decodedText);
            
            // --- DETECCI√ìN DE HEADER (Objeto {t:'H'...}) ---
            if (data.t === "H" && !session.active) {
                // Validaci√≥n b√°sica para asegurar que es nuestro header
                if(!data.c || !data.n) return;

                session.active = true;
                session.total = data.c;
                session.filename = data.n;
                session.chunks = new Array(data.c).fill(null);
                
                // Feedback UI
                document.getElementById('lbl-name').innerText = data.n.length > 15 ? data.n.substring(0,12)+"..." : data.n;
                document.getElementById('lbl-parts').innerText = `0 / ${data.c}`;
                document.getElementById('lbl-hash').innerText = data.h ? data.h.substring(0,6)+"..." : "N/A";
                
                updateStatus("‚úÖ HEADER OK. INICIA EL LOOP", "#00ff41");
                navigator.vibrate(200); // Vibraci√≥n larga confirmaci√≥n
                return;
            }

            // --- DETECCI√ìN DE DATOS (Array [index, data]) ---
            if (session.active && Array.isArray(data)) {
                const index = data[0];
                const content = data[1];

                if (session.chunks[index] === null) {
                    session.chunks[index] = content;
                    session.count++;
                    session.packetsSec++;
                    
                    updateProgress();

                    if (session.count === session.total) {
                        finishDownload();
                    }
                }
            }

        } catch (e) {
            // Ignorar ruido
        }
    }

    function onScanError(errorMessage) {
        // No hacer nada, es normal que falle frames borrosos
    }

    function updateStatus(msg, color) {
        const el = document.getElementById('status');
        el.innerText = msg;
        el.style.color = color || "#fff";
    }

    function updateProgress() {
        const pct = Math.floor((session.count / session.total) * 100);
        document.getElementById('bar').style.width = pct + "%";
        document.getElementById('pct').innerText = pct + "%";
        document.getElementById('lbl-parts').innerText = `${session.count} / ${session.total}`;
    }

    function finishDownload() {
        html5QrCode.stop();
        updateStatus("COMPLETADO 100%", "#00ff41");
        document.getElementById('btn-dl').style.display = "block";
        navigator.vibrate([100,50,100]);
    }

    window.downloadFile = function() {
        // Reconstrucci√≥n del Blob
        const b64Data = session.chunks.join('');
        const byteCharacters = atob(b64Data);
        const byteArrays = [];
        const sliceSize = 1024;

        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            const slice = byteCharacters.slice(offset, offset + sliceSize);
            const byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }

        const blob = new Blob(byteArrays, {type: "application/octet-stream"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = session.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Medidor de velocidad
    setInterval(() => {
        if(session.active && session.count < session.total) {
            document.getElementById('lbl-speed').innerText = session.packetsSec;
            session.packetsSec = 0;
        }
    }, 1000);

    // Iniciar al cargar
    window.onload = startCamera;

</script>
</body>
</html>

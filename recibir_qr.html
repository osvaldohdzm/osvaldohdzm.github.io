<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Receptor V15 - Dashboard Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --border: #30363d; --accent: #2f81f7; --success: #2ea043; --err: #da3633; --text: #c9d1d9; }
        
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        /* --- HEADER --- */
        .header {
            width: 100%; max-width: 800px; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); margin-bottom: 20px;
        }
        .brand { font-weight: bold; font-size: 1.1rem; color: #fff; display: flex; align-items: center; gap: 10px; }
        .badge { background: var(--panel); border: 1px solid var(--border); padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; color: var(--accent); }

        /* --- SELECTOR DE MODO --- */
        .mode-switch {
            display: flex; gap: 10px; background: var(--panel); padding: 5px; border-radius: 6px; border: 1px solid var(--border);
        }
        .mode-btn {
            background: transparent; border: none; color: #8b949e; padding: 8px 15px; cursor: pointer; font-weight: 600; border-radius: 4px; transition: all 0.2s;
        }
        .mode-btn.active { background: var(--accent); color: #fff; }
        .mode-btn:hover:not(.active) { color: #fff; }

        /* --- ZONA DE ESCANEO (CONTENIDA) --- */
        .viewport-container {
            width: 95%; max-width: 600px; aspect-ratio: 4/3;
            background: #000; border: 2px solid var(--border); border-radius: 8px;
            position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        #reader { width: 100%; height: 100%; object-fit: cover; } /* Para HTML5Qrcode */
        #screen-video { width: 100%; height: 100%; object-fit: contain; display: none; } /* Para Pantalla */
        
        /* Overlay de gu√≠a */
        .scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0) 40%, rgba(47, 129, 247, 0.1) 50%, rgba(0,0,0,0) 60%);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- DASHBOARD DE DATOS --- */
        .dashboard { width: 95%; max-width: 600px; margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; }
        
        .info-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .file-name { color: #fff; font-weight: bold; }
        
        .progress-track { height: 8px; background: #21262d; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.1s; }

        /* --- BOTONES DE ACCI√ìN --- */
        .actions { display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        button.main-action {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);
            font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .btn-waiting { background: var(--panel); color: #484f58; cursor: not-allowed; }
        .btn-download { background: var(--success); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-missing { background: var(--err); color: #fff; display: none; }

        /* Canvas oculto para procesar pantalla */
        #worker-canvas { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">üì° RECEPTOR V15 <span class="badge">TITANIUM CORE</span></div>
        <div class="mode-switch">
            <button class="mode-btn active" onclick="setMode('cam')" id="btn-mode-cam">üì∑ C√ÅMARA</button>
            <button class="mode-btn" onclick="setMode('screen')" id="btn-mode-screen">üñ•Ô∏è PANTALLA</button>
        </div>
    </div>

    <div class="viewport-container">
        <div id="reader"></div> <video id="screen-video" autoplay playsinline muted></video> <div class="scan-overlay"></div>
    </div>

    <div class="dashboard">
        <div class="card">
            <div class="info-row">
                <span class="file-name" id="lbl-name">Esperando se√±al...</span>
                <span id="lbl-pct">0%</span>
            </div>
            <div class="info-row" style="font-size: 0.75rem; color: #8b949e;">
                <span id="lbl-hash">SHA: -</span>
                <span id="lbl-count">0/0 Paquetes</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="bar"></div>
            </div>
        </div>

        <div class="actions">
            <button id="btn-missing" class="main-action btn-missing" onclick="copyReport()">‚ö†Ô∏è COPIAR REPORTE DE ERRORES</button>
            <button id="btn-save" class="main-action btn-waiting" disabled onclick="downloadFile()">ESPERANDO FINALIZACI√ìN...</button>
        </div>
    </div>

    <canvas id="worker-canvas"></canvas>

<script>
    // --- ESTADO DEL SISTEMA ---
    const sys = {
        mode: 'cam', // 'cam' o 'screen'
        active: false, chunks: [], received: 0, total: 0,
        meta: { n: "", h: "" },
        loopId: null
    };

    // --- VARIABLES DE ESCANEO ---
    const html5QrCode = new Html5Qrcode("reader");
    let screenStream = null;
    let barcodeDetector = null;

    // Inicializar
    window.onload = () => {
        // Verificar soporte nativo para escanear pantalla (Chrome/Edge/Android)
        if ('BarcodeDetector' in window) {
            barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        }
        setMode('cam');
    };

    // --- CAMBIO DE MODOS ---
    async function setMode(mode) {
        stopAll();
        sys.mode = mode;
        
        // UI Toggle
        document.getElementById('btn-mode-cam').className = mode === 'cam' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('btn-mode-screen').className = mode === 'screen' ? 'mode-btn active' : 'mode-btn';

        const readerDiv = document.getElementById('reader');
        const videoTag = document.getElementById('screen-video');

        if (mode === 'cam') {
            readerDiv.style.display = 'block';
            videoTag.style.display = 'none';
            // Iniciar HTML5Qrcode
            html5QrCode.start({ facingMode: "environment" }, { fps: 30, qrbox: 250 }, onData, () => {});
        } 
        else {
            readerDiv.style.display = 'none';
            videoTag.style.display = 'block';
            try {
                // Solicitar Pantalla
                screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { cursor: "never" }, audio: false 
                });
                videoTag.srcObject = screenStream;
                // Iniciar Loop de detecci√≥n de pantalla
                requestAnimationFrame(scanScreenLoop);
            } catch (err) {
                alert("Cancelaste compartir pantalla o no tienes permisos.");
                setMode('cam');
            }
        }
    }

    function stopAll() {
        if(html5QrCode.isScanning) html5QrCode.stop().catch(()=>{});
        if(screenStream) screenStream.getTracks().forEach(track => track.stop());
        cancelAnimationFrame(sys.loopId);
    }

    // --- LOOP DE ESCANEO DE PANTALLA ---
    async function scanScreenLoop() {
        if(sys.mode !== 'screen') return;
        
        const video = document.getElementById('screen-video');
        
        if (video.readyState === video.HAVE_ENOUGH_DATA && barcodeDetector) {
            try {
                // Usamos la API nativa del navegador (S√∫per r√°pida)
                const barcodes = await barcodeDetector.detect(video);
                barcodes.forEach(code => onData(code.rawValue));
            } catch (e) {
                // Fallback si falla la API nativa (raro en Chrome)
            }
        }
        sys.loopId = requestAnimationFrame(scanScreenLoop);
    }

    // --- L√ìGICA DE DATOS (EL N√öCLEO ROBUSTO) ---
    function onData(txt) {
        try {
            const d = JSON.parse(txt);

            // HEADER
            if (d.t === "H" && !sys.active) {
                sys.active = true;
                sys.total = d.c;
                sys.meta = d;
                sys.chunks = new Array(d.c).fill(null); // Memoria para bytes
                
                document.getElementById('lbl-name').innerText = d.n;
                document.getElementById('lbl-hash').innerText = "SHA: " + d.h.substring(0,8) + "...";
                updateUI();
            }

            // DATA BLOCK
            if (sys.active && Array.isArray(d)) {
                const idx = d[0];
                const b64 = d[1];
                
                if (idx < sys.total && sys.chunks[idx] === null) {
                    // DECODIFICACI√ìN SEGURA (Uint8Array)
                    const bin = atob(b64);
                    const bytes = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    
                    sys.chunks[idx] = bytes;
                    sys.received++;
                    updateUI();
                }
            }
        } catch (e) {}
    }

    function updateUI() {
        const pct = Math.floor((sys.received / sys.total) * 100);
        
        document.getElementById('bar').style.width = pct + "%";
        document.getElementById('lbl-pct').innerText = pct + "%";
        document.getElementById('lbl-count').innerText = `${sys.received}/${sys.total} Paquetes`;

        const btnSave = document.getElementById('btn-save');
        const btnMiss = document.getElementById('btn-missing');

        if (sys.received === sys.total) {
            btnMiss.style.display = 'none';
            btnSave.disabled = false;
            btnSave.className = "main-action btn-download";
            btnSave.innerText = "‚úÖ DESCARGAR ARCHIVO";
            // Auto-stop para ahorrar CPU
            if(sys.mode === 'cam') stopAll();
        } 
        else if (sys.received > 0 && pct < 100) {
            // Mostrar bot√≥n de error si hay actividad
            btnMiss.style.display = 'block';
        }
    }

    function copyReport() {
        let missing = [];
        for(let i=0; i<sys.total; i++) if(sys.chunks[i] === null) missing.push(i);
        
        if(missing.length === 0) return;

        // Comprimir rangos (1,2,3 -> 1-3)
        let ranges = [], start = missing[0], prev = missing[0];
        for(let i=1; i<=missing.length; i++) {
            if(missing[i] === prev+1) prev = missing[i];
            else {
                ranges.push(start===prev ? start : `${start}-${prev}`);
                start = missing[i]; prev = missing[i];
            }
        }
        
        const report = ranges.join(',');
        navigator.clipboard.writeText(report);
        alert("üìã REPORTE COPIADO:\n" + report + "\n\n>> Pegar en Emisor");
    }

    async function downloadFile() {
        const blob = new Blob(sys.chunks, { type: "application/octet-stream" });
        
        // Hash check
        const buf = await blob.arrayBuffer();
        const hashBuf = await crypto.subtle.digest('SHA-256', buf);
        const hashHex = Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        
        // Validaci√≥n laxa (primeros 16 chars) o estricta
        if (hashHex.startsWith(sys.meta.h)) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = sys.meta.n;
            a.click();
        } else {
            alert("‚ö†Ô∏è Error de integridad. El hash no coincide.");
        }
    }
</script>
</body>
</html>

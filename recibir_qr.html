<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptor V2</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { background: #000; color: #eee; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #reader { width: 100%; flex: 1; background: #111; border-bottom: 2px solid #333; }
        .controls { padding: 15px; background: #222; border-top: 1px solid #444; }
        
        .progress-wrap { height: 25px; background: #444; border-radius: 12px; overflow: hidden; margin-bottom: 10px; position: relative; }
        .bar { height: 100%; background: #00ff41; width: 0%; transition: width 0.1s; }
        .pct { position: absolute; width: 100%; text-align: center; top: 3px; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 0.9rem; }

        .status-box { display: grid; grid-template-columns: 1fr 1fr; font-size: 0.8rem; gap: 5px; color: #aaa; }
        .highlight { color: #fff; font-weight: bold; }
        
        .log { font-family: monospace; font-size: 0.7rem; color: #00ff41; max-height: 60px; overflow-y: hidden; margin-top: 5px; }
        
        #btn-dl { width: 100%; padding: 15px; background: #00ff41; color: black; font-weight: bold; border: none; border-radius: 8px; display: none; font-size: 1rem; margin-top: 10px;}
    </style>
</head>
<body>

<div id="reader"></div>

<div class="controls">
    <div class="progress-wrap">
        <div id="bar" class="bar"></div>
        <div id="pct" class="pct">ESPERANDO HEADER...</div>
    </div>
    
    <div class="status-box">
        <div>Archivo: <span id="fname" class="highlight">-</span></div>
        <div>Partes: <span id="parts" class="highlight">0/0</span></div>
        <div>Estado: <span id="status" style="color:yellow">Cámara Iniciando</span></div>
        <div>Vel: <span id="speed">0</span> pq/s</div>
    </div>
    <div id="log" class="log">> Sistema listo.</div>
    <button id="btn-dl" onclick="saveFile()">DESCARGAR</button>
</div>

<script>
    let session = {
        active: false,
        total: 0,
        chunks: [],
        receivedCount: 0,
        name: "",
        hash: "",
        lastTime: Date.now(),
        packets: 0
    };

    function log(m) { document.getElementById('log').innerText = "> " + m; }

    // Configuración de escáner agresiva
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 40, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
        (decodedText) => {
            handleScan(decodedText);
        },
        (errorMessage) => { /* ignorar errores de frame */ }
    ).then(() => {
        document.getElementById('status').innerText = "BUSCANDO QR...";
        document.getElementById('status').style.color = "#00ff41";
    });

    function handleScan(text) {
        try {
            const data = JSON.parse(text);

            // TIPO 1: HEADER (Objeto con propiedad 't'="H")
            if (data.t === "H" && !session.active) {
                initSession(data);
                return;
            }

            // TIPO 2: DATA (Array [indice, base64])
            if (Array.isArray(data) && session.active) {
                const idx = data[0];
                const content = data[1];

                if (session.chunks[idx] === null) {
                    session.chunks[idx] = content;
                    session.receivedCount++;
                    session.packets++;
                    updateProgress();
                    
                    if(session.receivedCount === session.total) {
                        finishSession();
                    }
                }
            }
        } catch (e) {
            // No es JSON válido, ignorar
        }
    }

    function initSession(header) {
        session.active = true;
        session.total = header.c;
        session.name = header.n;
        session.hash = header.h;
        session.chunks = new Array(header.c).fill(null);
        session.receivedCount = 0;
        
        document.getElementById('fname').innerText = header.n.substring(0,15);
        document.getElementById('parts').innerText = `0/${header.c}`;
        document.getElementById('pct').innerText = "RECIBIENDO DATOS...";
        document.getElementById('status').innerText = "SINCRONIZADO";
        log(`Header recibido. Esperando ${header.c} bloques.`);
        
        // Feedback vibración
        if(navigator.vibrate) navigator.vibrate(200);
    }

    function updateProgress() {
        const p = Math.floor((session.receivedCount / session.total) * 100);
        document.getElementById('bar').style.width = p + "%";
        document.getElementById('pct').innerText = `${p}%`;
        document.getElementById('parts').innerText = `${session.receivedCount}/${session.total}`;
    }

    // Calculador de velocidad
    setInterval(() => {
        if(session.active && session.receivedCount < session.total) {
            document.getElementById('speed').innerText = session.packets;
            session.packets = 0;
        }
    }, 1000);

    async function finishSession() {
        log("Descarga completada. Verificando...");
        html5QrCode.stop();
        document.getElementById('status').innerText = "PROCESANDO...";
        
        const blob = b64toBlob(session.chunks.join(''));
        
        // Verificar Hash simple (opcional, primeros 10 chars)
        // En prod usarías todo el SHA256, aquí simplificamos para velocidad UI
        document.getElementById('btn-dl').style.display = "block";
        document.getElementById('pct').innerText = "COMPLETADO";
        document.getElementById('bar').style.background = "#fff";
        
        if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
        log("Listo para guardar.");
    }

    function b64toBlob(b64Data) {
        const sliceSize = 512;
        const byteCharacters = atob(b64Data);
        const byteArrays = [];
        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            const slice = byteCharacters.slice(offset, offset + sliceSize);
            const byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
            const byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }
        return new Blob(byteArrays, {type: "application/octet-stream"});
    }

    window.saveFile = function() {
        const blob = b64toBlob(session.chunks.join(''));
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = session.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>
</body>
</html>

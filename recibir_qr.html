<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECEPTOR TITANIUM V13</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { background: #000; color: #fff; font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* C√ÅMARA */
        #reader { flex: 1; width: 100%; object-fit: cover; }
        
        /* HUD (HEAD UP DISPLAY) */
        .hud { 
            background: rgba(10, 10, 10, 0.95); border-top: 2px solid #333; 
            padding: 15px; display: flex; flex-direction: column; gap: 10px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        .meta-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #aaa; }
        .filename { color: #fff; font-weight: bold; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* BARRA DE PROGRESO "DIGITAL" */
        .progress-track { height: 12px; background: #222; border-radius: 6px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; width: 0%; background: #00f3ff; transition: width 0.2s ease-out; box-shadow: 0 0 10px #00f3ff; }
        
        /* ALERTAS */
        .status-box { 
            padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 0.9rem; cursor: pointer; display: none; 
        }
        .st-missing { background: #330000; border: 1px solid #ff0055; color: #ff0055; }
        .st-success { background: #002200; border: 1px solid #00ff41; color: #00ff41; }

        button { 
            width: 100%; padding: 15px; background: #222; color: #fff; border: 1px solid #444; 
            border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer;
        }
        button:disabled { opacity: 0.3; cursor: default; }
    </style>
</head>
<body>

<div id="reader"></div>

<div class="hud">
    <div class="meta-row">
        <div class="filename" id="lbl-name">ESPERANDO SE√ëAL...</div>
        <div id="lbl-pct">0%</div>
    </div>
    
    <div class="progress-track">
        <div class="progress-fill" id="bar"></div>
    </div>

    <div id="alert-missing" class="status-box st-missing" onclick="copyMissingReport()">
        ‚ö†Ô∏è PAQUETES PERDIDOS (Click Copiar)
    </div>

    <button id="btn-save" disabled onclick="saveFile()">üíæ GUARDAR ARCHIVO</button>
</div>

<script>
    const sys = {
        active: false,
        totalChunks: 0,
        receivedChunks: 0,
        dataSlots: [], // Array de Uint8Array (NO Strings)
        meta: { name: "", hash: "" }
    };

    const scanner = new Html5Qrcode("reader");
    
    // Configuraci√≥n optimizada para velocidad
    const config = { fps: 30, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
    
    scanner.start({ facingMode: "environment" }, config, onData, onError);

    function onData(decodedText) {
        try {
            const packet = JSON.parse(decodedText);

            // TIPO 1: HEADER
            if(packet.t === "H" && !sys.active) {
                initSession(packet);
                return;
            }

            // TIPO 2: DATA BLOQUE [index, base64]
            if(sys.active && Array.isArray(packet)) {
                processBlock(packet[0], packet[1]);
            }

        } catch(e) {
            // Ignorar JSON malformado (Ruido)
        }
    }

    function onError(err) { /* Ignorar cuadros vac√≠os */ }

    function initSession(header) {
        sys.active = true;
        sys.totalChunks = header.c;
        sys.meta.name = header.n;
        sys.meta.hash = header.h;
        // Pre-reservar memoria
        sys.dataSlots = new Array(header.c).fill(null);
        sys.receivedChunks = 0;

        document.getElementById('lbl-name').innerText = header.n;
        updateUI();
    }

    function processBlock(index, base64Data) {
        // 1. Verificaciones r√°pidas
        if(index >= sys.totalChunks || sys.dataSlots[index] !== null) return;

        // 2. DECODIFICACI√ìN SEGURA (EL CORAZ√ìN DEL SISTEMA)
        try {
            // Convertimos Base64 -> String Binario -> Uint8Array INMEDIATAMENTE
            // Si el Base64 est√° roto, 'atob' falla aqu√≠ y NO guardamos nada.
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // 3. Guardar SOLO si fue exitoso
            sys.dataSlots[index] = bytes;
            sys.receivedChunks++;
            updateUI();

        } catch (error) {
            console.warn("Bloque corrupto detectado y rechazado:", index);
            // No hacemos nada m√°s, el bloque queda como null y se pedir√° luego.
        }
    }

    function updateUI() {
        const pct = Math.floor((sys.receivedChunks / sys.totalChunks) * 100);
        document.getElementById('bar').style.width = pct + "%";
        document.getElementById('lbl-pct').innerText = pct + "%";

        const missingDiv = document.getElementById('alert-missing');
        const saveBtn = document.getElementById('btn-save');

        if(sys.receivedChunks === sys.totalChunks) {
            missingDiv.style.display = 'none';
            saveBtn.disabled = false;
            saveBtn.style.background = "#00ff41";
            saveBtn.style.color = "#000";
            saveBtn.innerText = "‚úÖ DESCARGAR AHORA";
            // Detener c√°mara para ahorrar recursos
            scanner.stop().catch(()=>{});
        } else if (sys.receivedChunks > 0 && pct < 100) {
            missingDiv.style.display = 'block';
            missingDiv.innerText = `‚ö†Ô∏è FALTA ${(sys.totalChunks - sys.receivedChunks)} BLOQUES (Click para Reporte)`;
        }
    }

    function copyMissingReport() {
        // Generar lista comprimida (ej: "1-5, 8, 10-12")
        let missing = [];
        for(let i=0; i<sys.totalChunks; i++) {
            if(sys.dataSlots[i] === null) missing.push(i);
        }

        if(missing.length === 0) return;

        let ranges = [];
        let start = missing[0], prev = missing[0];

        for(let i=1; i<=missing.length; i++) {
            if(missing[i] === prev + 1) {
                prev = missing[i];
            } else {
                ranges.push(start === prev ? start : `${start}-${prev}`);
                start = missing[i];
                prev = missing[i];
            }
        }
        
        const report = ranges.join(',');
        navigator.clipboard.writeText(report).then(() => {
            alert("üìã Reporte copiado:\n" + report + "\n\n>> P√©galo en el Emisor.");
        });
    }

    async function saveFile() {
        if(sys.receivedChunks < sys.totalChunks) return;

        // ENSAMBLAJE FINAL
        // Como ya tenemos Uint8Arrays, el Blob se crea instant√°neamente sin conversiones.
        const blob = new Blob(sys.dataSlots, { type: "application/octet-stream" });
        
        // Verificaci√≥n Hash (Opcional pero recomendada)
        const buffer = await blob.arrayBuffer();
        const hashBuf = await crypto.subtle.digest('SHA-256', buffer);
        const hashHex = Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');

        if(hashHex.startsWith(sys.meta.hash)) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = sys.meta.name;
            link.click();
        } else {
            alert("‚ùå ERROR DE INTEGRIDAD\nEl hash final no coincide. El archivo podr√≠a estar corrupto.");
        }
    }
</script>
</body>
</html>

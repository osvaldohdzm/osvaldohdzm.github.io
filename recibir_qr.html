<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptor V7 - Pro Dashboard</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { 
            --bg: #0a0a0a; 
            --panel: #141414; 
            --border: #333; 
            --primary: #00ff41; 
            --accent: #0088ff;
            --text-main: #e0e0e0;
            --text-dim: #888;
        }
        * { box-sizing: border-box; }
        
        body { 
            background: var(--bg); color: var(--text-main); 
            font-family: 'Consolas', 'Monaco', monospace; /* Fuente estilo Hacker */
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- VISOR SUPERIOR --- */
        #media-stage {
            flex: 1; position: relative; background: #000; border-bottom: 1px solid var(--primary);
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        #reader, #screen-video { width: 100%; height: 100%; object-fit: contain; }
        #reader { display: none; }
        #screen-video { display: none; }

        .overlay-status {
            position: absolute; top: 10px; left: 10px; 
            background: rgba(0,0,0,0.8); padding: 5px 10px; border: 1px solid var(--primary);
            color: var(--primary); font-size: 0.8rem; pointer-events: none;
        }

        /* --- PANEL DE CONTROL INFERIOR --- */
        .dashboard { 
            height: 50vh; background: var(--panel); display: flex; flex-direction: column; padding: 15px; gap: 15px;
            overflow-y: auto;
        }

        /* Tabs de Fuente */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .tab { 
            flex: 1; padding: 10px; cursor: pointer; text-align: center; color: var(--text-dim); 
            border: 1px solid transparent; transition: 0.2s;
        }
        .tab:hover { color: #fff; background: #222; }
        .tab.active { 
            color: var(--primary); border-bottom: 2px solid var(--primary); background: #0f1f0f; font-weight: bold; 
        }

        /* Tarjeta de Informaci贸n del Archivo (METADATOS) */
        .meta-card {
            display: grid; grid-template-columns: 80px 1fr; gap: 10px;
            background: #1a1a1a; border: 1px solid var(--border); padding: 10px; border-radius: 4px;
        }
        .file-icon { 
            background: #222; display: flex; align-items: center; justify-content: center; 
            font-size: 2rem; color: var(--accent); border: 1px solid #333;
        }
        .file-details { display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .detail-row { font-size: 0.8rem; color: var(--text-dim); display: flex; justify-content: space-between; }
        .detail-val { color: #fff; font-weight: bold; }
        .hash-txt { font-family: monospace; font-size: 0.7rem; color: var(--accent); word-break: break-all; }

        /* Barras y Estad铆sticas */
        .progress-section { display: flex; flex-direction: column; gap: 5px; }
        .progress-track { height: 8px; background: #222; width: 100%; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.1s; }
        
        .stats-row { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); }

        /* Consola de Diagn贸stico */
        .console-log {
            flex: 1; background: #000; border: 1px solid #333; padding: 5px; 
            font-size: 0.7rem; color: #aaa; overflow-y: auto; font-family: monospace;
            min-height: 60px;
        }
        .log-success { color: var(--primary); }
        .log-warn { color: #ffcc00; }
        .log-err { color: #ff3333; }

        /* Bot贸n Acci贸n */
        .action-btn {
            width: 100%; padding: 15px; background: #222; color: #555; border: 1px solid #333;
            font-weight: bold; cursor: not-allowed; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s;
        }
        .action-btn.ready { background: var(--primary); color: #000; cursor: pointer; border: none; box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }

    </style>
</head>
<body onload="setMode('cam')">

<div id="media-stage">
    <div id="reader"></div>
    <video id="screen-video" autoplay playsinline muted></video>
    <div class="overlay-status" id="status-overlay">ESPERANDO FUENTE...</div>
</div>

<div class="dashboard">
    
    <div class="tabs">
        <div class="tab" id="tab-cam" onclick="setMode('cam')">[ CMARA ]</div>
        <div class="tab" id="tab-screen" onclick="setMode('screen')">[ PANTALLA / VENTANA ]</div>
    </div>

    <div class="meta-card">
        <div class="file-icon"></div>
        <div class="file-details">
            <div class="detail-row">ARCHIVO: <span class="detail-val" id="meta-name">---</span></div>
            <div class="detail-row">TAMAO: <span class="detail-val" id="meta-size">---</span></div>
            <div class="detail-row" style="margin-top:2px;">HASH (SHA-256):</div>
            <div class="hash-txt" id="meta-hash">Esperando Header...</div>
        </div>
    </div>

    <div class="progress-section">
        <div class="stats-row">
            <span id="stat-blocks">Bloques: 0 / 0</span>
            <span id="stat-speed">0 pq/s</span>
        </div>
        <div class="progress-track">
            <div id="prog-bar" class="progress-fill"></div>
        </div>
        <div class="stats-row">
            <span id="stat-pct">0%</span>
            <span id="stat-status">Inactivo</span>
        </div>
    </div>

    <div class="console-log" id="sys-log">
        > Sistema iniciado v7.0<br>
        > Selecciona una fuente de video...
    </div>

    <button id="btn-action" class="action-btn" onclick="downloadFile()">ESPERANDO DATOS...</button>

    <div id="mac-hint" style="display:none; color:#ffcc00; font-size:0.7rem; text-align:center;">
        锔 Mac detectado: Si la pantalla est谩 negra, activa permisos en Ajustes > Privacidad.
    </div>

</div>

<script>
    // --- SISTEMA CENTRAL ---
    let sys = {
        qr: null,           // Instancia Html5Qrcode
        stream: null,       // MediaStream de Pantalla
        detector: null,     // BarcodeDetector Nativo
        loop: null,         // AnimationFrame ID
        session: {
            active: false,
            name: "unknown.bin",
            total: 0,
            chunks: [],
            count: 0,
            hash: null,
            startTime: 0,
            packetsSec: 0
        }
    };

    // --- LOGGING ---
    function log(msg, type="") {
        const c = document.getElementById('sys-log');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        c.innerHTML += `<span class="log-${type}">[${time}] ${msg}</span><br>`;
        c.scrollTop = c.scrollHeight;
    }

    // --- MODOS DE ENTRADA ---
    async function setMode(mode) {
        await stopAll();
        
        // UI Tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        document.getElementById('mac-hint').style.display = 'none';

        if(mode === 'cam') {
            document.getElementById('reader').style.display = 'block';
            document.getElementById('status-overlay').innerText = "CMARA ACTIVA";
            initCam();
        } else {
            document.getElementById('screen-video').style.display = 'block';
            document.getElementById('status-overlay').innerText = "SELECCIONA VENTANA";
            initScreen();
        }
    }

    async function stopAll() {
        if(sys.qr && sys.qr.isScanning) await sys.qr.stop().catch(()=>{});
        if(sys.stream) sys.stream.getTracks().forEach(t => t.stop());
        if(sys.loop) cancelAnimationFrame(sys.loop);
        
        document.getElementById('reader').style.display = 'none';
        document.getElementById('screen-video').style.display = 'none';
    }

    // --- INICIALIZACIN CMARA ---
    async function initCam() {
        sys.qr = new Html5Qrcode("reader");
        try {
            await sys.qr.start(
                { facingMode: "environment" }, 
                { fps: 30, qrbox: (w,h)=>({width: w*0.8, height: w*0.8}) },
                onData, 
                ()=>{}
            );
            log("C谩mara iniciada correctamente", "success");
        } catch(e) { 
            log("Error C谩mara: " + e, "err"); 
        }
    }

    // --- INICIALIZACIN PANTALLA ---
    async function initScreen() {
        if ('BarcodeDetector' in window) {
            sys.detector = new BarcodeDetector({ formats: ['qr_code'] });
        } else {
            log("锔 Sin aceleraci贸n GPU (BarcodeDetector). Modo CPU lento.", "warn");
        }

        try {
            sys.stream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" }, audio: false
            });
            
            const vid = document.getElementById('screen-video');
            vid.srcObject = sys.stream;

            // Detecci贸n Mac
            sys.stream.getVideoTracks()[0].onended = () => {
                 if(navigator.platform.toUpperCase().includes('MAC')) 
                    document.getElementById('mac-hint').style.display = 'block';
            };

            const loop = async () => {
                if(!sys.stream.active) return;
                if(vid.readyState === 4 && sys.detector) {
                    try {
                        const bitmaps = await sys.detector.detect(vid);
                        bitmaps.forEach(b => onData(b.rawValue));
                    } catch(e){}
                }
                sys.loop = requestAnimationFrame(loop);
            };
            loop();
            log("Captura de pantalla iniciada", "success");

        } catch(e) {
            log("Captura cancelada o error", "warn");
            setMode('cam');
        }
    }

    // --- PROCESAMIENTO DE DATOS ---
    function onData(text) {
        try {
            const data = JSON.parse(text);

            // 1. HEADER RECIBIDO
            if (data.t === "H" && !sys.session.active) {
                sys.session.active = true;
                sys.session.total = data.c;
                sys.session.name = data.n;
                sys.session.hash = data.h || "No incluido en header";
                sys.session.chunks = new Array(data.c).fill(null);
                
                // Actualizar UI Header
                document.getElementById('meta-name').innerText = data.n;
                document.getElementById('meta-hash').innerText = sys.session.hash;
                document.getElementById('meta-size').innerText = `${data.c} BLOQUES`;
                
                log(`HEADER: ${data.n} (${data.c} partes)`, "success");
                updateStats();
                return;
            }

            // 2. BLOQUE DE DATOS
            if (sys.session.active && Array.isArray(data)) {
                const [idx, content] = data;
                
                if (idx < sys.session.total && sys.session.chunks[idx] === null) {
                    sys.session.chunks[idx] = content;
                    sys.session.count++;
                    sys.session.packetsSec++;
                    updateStats();
                }
            }
        } catch(e) {} // Ignorar ruido
    }

    // --- ACTUALIZACIN UI ---
    function updateStats() {
        const s = sys.session;
        const pct = Math.floor((s.count / s.total) * 100);
        
        // Barras
        document.getElementById('prog-bar').style.width = pct + "%";
        document.getElementById('stat-pct').innerText = pct + "%";
        document.getElementById('stat-blocks').innerText = `Bloques: ${s.count} / ${s.total}`;
        document.getElementById('stat-status').innerText = pct === 100 ? "COMPLETADO" : "RECIBIENDO...";

        // Completado
        if (s.count === s.total) {
            const btn = document.getElementById('btn-action');
            if (!btn.classList.contains('ready')) {
                btn.classList.add('ready');
                btn.innerText = " GUARDAR ARCHIVO";
                log("Transferencia finalizada al 100%", "success");
                document.getElementById('status-overlay').innerText = "LISTO PARA GUARDAR";
                stopAll();
            }
        } 
        // Diagn贸stico (Si se estanca)
        else if (pct > 95 && s.packetsSec === 0) {
            checkMissing();
        }
    }

    function checkMissing() {
        let first = -1, last = -1;
        sys.session.chunks.forEach((c, i) => {
            if(c === null) {
                if(first === -1) first = i;
                last = i;
            }
        });
        if(first !== -1) {
            document.getElementById('status-overlay').innerText = `FALTAN: ${first} - ${last}`;
        }
    }

    // --- DESCARGA SEGURA ---
    window.downloadFile = function() {
        const s = sys.session;
        if(s.count !== s.total) {
            log("锔 Incompleto. Revisa faltantes.", "warn");
            checkMissing();
            return;
        }

        try {
            log("Reconstruyendo binario...", "");
            const b64 = s.chunks.join('');
            const bin = atob(b64);
            const arr = new Uint8Array(bin.length);
            for(let i=0; i<bin.length; i++) arr[i] = bin.charCodeAt(i);
            
            const blob = new Blob([arr], {type: "application/octet-stream"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = s.name;
            a.click();
            log("Archivo guardado.", "success");
            
        } catch(e) {
            log("Error fatal en reconstrucci贸n: " + e, "err");
        }
    }

    // Veloc铆metro
    setInterval(() => {
        if(sys.session.active) {
            document.getElementById('stat-speed').innerText = sys.session.packetsSec + " pq/s";
            sys.session.packetsSec = 0;
        }
    }, 1000);

</script>
</body>
</html>

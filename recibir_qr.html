<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Receptor V11 - Diagn√≥stico</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --bg: #000; --panel: #111; --main: #00ff41; --err: #ff3333; --warn: #ffcc00; }
        body { background: var(--bg); color: #fff; font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #stage { flex: 1; background: #050505; display: flex; justify-content: center; align-items: center; position: relative; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        .hud { 
            background: var(--panel); border-top: 2px solid #333; padding: 10px; 
            display: flex; flex-direction: column; gap: 8px; z-index: 100;
        }

        .bar-container { height: 15px; background: #222; width: 100%; position: relative; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--main); transition: width 0.2s; }
        
        .info-row { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; }
        .big-text { font-size: 1.2rem; font-weight: bold; color: #fff; }
        
        /* Caja de Errores */
        .error-box { 
            background: #220000; border: 1px solid var(--err); color: var(--err); 
            padding: 8px; font-size: 0.8rem; display: none; flex-direction: column; gap: 5px;
        }
        .copy-btn { 
            background: var(--warn); color: #000; border: none; padding: 5px; 
            cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.75rem;
        }

        button.action-btn { width: 100%; padding: 12px; background: #333; color: #fff; border: 1px solid #555; font-weight: bold; cursor: pointer; }
        button.success { background: var(--main); color: #000; border-color: var(--main); }
    </style>
</head>
<body onload="init()">

<div id="stage">
    <div id="reader"></div>
    <div style="position:absolute; color:var(--main); font-size:2rem; opacity:0.5; pointer-events:none;">[ ]</div>
</div>

<div class="hud">
    <div class="info-row">
        <span id="lbl-name">Esperando Header...</span>
        <span id="lbl-hash">SHA: -</span>
    </div>
    
    <div class="bar-container">
        <div class="bar-fill" id="prog-bar"></div>
    </div>
    
    <div class="info-row">
        <span class="big-text" id="lbl-perc">0%</span>
        <span id="lbl-count">0 / 0 Paquetes</span>
    </div>

    <div id="missing-panel" class="error-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>‚ö†Ô∏è BLOQUES FALTANTES DETECTADOS</span>
            <button class="copy-btn" onclick="copyMissing()">üìã COPIAR REPORTE</button>
        </div>
        <div id="missing-list" style="word-break: break-all; opacity: 0.8; max-height: 40px; overflow-y: auto;">-</div>
    </div>

    <button id="btn-action" class="action-btn" onclick="finalize()" disabled>ESPERANDO DATOS...</button>
</div>

<script>
    let sys = { 
        active: false, chunks: [], total: 0, receivedCount: 0, 
        meta: { name: "", hash: "" },
        missingStr: ""
    };
    let html5QrCode;

    function init() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 30, qrbox: 250, aspectRatio: 1.0 },
            onScan, 
            (err) => {} // Ignorar errores de frame vac√≠o
        );
    }

    function onScan(decodedText) {
        try {
            const data = JSON.parse(decodedText);
            
            // Caso 1: Header
            if(data.t === "H" && !sys.active) {
                startSession(data);
                return;
            }

            // Caso 2: Bloque de datos
            if(sys.active && Array.isArray(data)) {
                const idx = data[0];
                const content = data[1];
                
                if(idx < sys.total && sys.chunks[idx] === null) {
                    sys.chunks[idx] = content;
                    sys.receivedCount++;
                    updateUI();
                }
            }
        } catch(e) {
            // Ignorar basura
        }
    }

    function startSession(header) {
        sys.active = true;
        sys.total = header.c;
        sys.meta.name = header.n;
        sys.meta.hash = header.h;
        sys.chunks = new Array(sys.total).fill(null);
        sys.receivedCount = 0;
        
        document.getElementById('lbl-name').innerText = header.n.substring(0, 20);
        document.getElementById('lbl-hash').innerText = `SHA: ${header.h}...`;
        updateUI();
    }

    function updateUI() {
        const pct = Math.floor((sys.receivedCount / sys.total) * 100);
        document.getElementById('prog-bar').style.width = pct + "%";
        document.getElementById('lbl-perc').innerText = pct + "%";
        document.getElementById('lbl-count').innerText = `${sys.receivedCount} / ${sys.total}`;

        // L√≥gica de bloques faltantes (Se activa si hay gaps y tenemos >10% de datos)
        if(sys.receivedCount < sys.total && sys.receivedCount > 1) {
            calculateMissing();
        } else if (sys.receivedCount === sys.total) {
            document.getElementById('missing-panel').style.display = 'none';
            const btn = document.getElementById('btn-action');
            btn.disabled = false;
            btn.classList.add('success');
            btn.innerText = "‚úÖ DESCARGAR ARCHIVO";
        }
    }

    function calculateMissing() {
        let ranges = [];
        let start = -1;
        
        // Algoritmo para agrupar indices consecutivos: 1,2,3 -> "1-3"
        for(let i=0; i<sys.total; i++) {
            if(sys.chunks[i] === null) {
                if(start === -1) start = i;
            } else {
                if(start !== -1) {
                    ranges.push(start === i-1 ? `${start}` : `${start}-${i-1}`);
                    start = -1;
                }
            }
        }
        if(start !== -1) ranges.push(start === sys.total-1 ? `${start}` : `${start}-${sys.total-1}`);

        sys.missingStr = ranges.join(',');
        
        // Mostrar panel
        const pnl = document.getElementById('missing-panel');
        pnl.style.display = 'flex';
        // Mostrar solo un resumen visual corto
        const displayTxt = sys.missingStr.length > 50 ? sys.missingStr.substring(0,50)+"..." : sys.missingStr;
        document.getElementById('missing-list').innerText = displayTxt || "Analizando...";
    }

    function copyMissing() {
        if(!sys.missingStr) return;
        navigator.clipboard.writeText(sys.missingStr).then(() => {
            alert("üìã REPORTE COPIADO AL PORTAPAPELES\n\nP√©galo en el campo 'Recuperaci√≥n Inteligente' del Emisor.");
        });
    }

    async function finalize() {
        // 1. Reconstruir
        try {
            const b64 = sys.chunks.join('');
            const binStr = atob(b64);
            const len = binStr.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binStr.charCodeAt(i);

            // 2. Verificar Hash
            const hashBuf = await crypto.subtle.digest('SHA-256', bytes);
            const hashArr = Array.from(new Uint8Array(hashBuf));
            const calcHash = hashArr.map(b => b.toString(16).padStart(2, '0')).join('');

            // Validamos contra los 16 chars que mand√≥ el emisor
            if(calcHash.startsWith(sys.meta.hash)) {
                const blob = new Blob([bytes], {type: "application/octet-stream"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = sys.meta.name;
                a.click();
            } else {
                alert("‚ùå ERROR CR√çTICO DE HASH\nEl archivo est√° corrupto. Intenta escanear de nuevo los bloques faltantes.");
            }
        } catch(e) {
            alert("Error al reconstruir: " + e);
        }
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptor V6.2 - Stable Fix</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --bg: #050505; --main: #00ff41; --panel: #111; --warn: #ffcc00; }
        * { box-sizing: border-box; }
        
        body { 
            background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; 
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        #media-stage {
            flex: 1; position: relative; background: #000; 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        #reader { width: 100%; height: 100%; display: none; }
        #screen-video { width: 100%; height: 100%; object-fit: contain; display: none; }
        
        .overlay-guide {
            position: absolute; pointer-events: none; z-index: 10;
            bottom: 20px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px;
            color: var(--main); font-weight: bold; font-size: 0.9rem; border: 1px solid var(--main);
        }

        .controls { 
            background: var(--panel); border-top: 2px solid #333; 
            padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 20;
            max-height: 40vh; overflow-y: auto;
        }

        .btn-group { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer; color: #fff; background: #333;
            transition: 0.2s;
        }
        button:hover { background: #444; }
        .btn-active { background: #003300; border: 1px solid var(--main); color: var(--main); }

        .progress-container { height: 15px; background: #222; border-radius: 8px; overflow: hidden; position: relative; }
        .bar { height: 100%; width: 0%; background: var(--main); transition: width 0.3s; }
        
        .info { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.8rem; color: #aaa; }
        .info span { color: #fff; font-weight: bold; }

        #diag-panel {
            background: #2a2200; border: 1px dashed var(--warn); padding: 10px; border-radius: 6px;
            display: none; animation: popIn 0.3s;
        }
        .diag-title { color: var(--warn); font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        .diag-data { font-family: monospace; font-size: 1.1rem; color: #fff; background: #000; padding: 5px; display: block; text-align: center; }
        .diag-note { font-size: 0.75rem; color: #ccc; margin-top: 5px; display: block; }

        #mac-help {
            background: #222; border: 1px solid #555; padding: 10px; border-radius: 6px;
            display: none; color: #ccc; font-size: 0.8rem;
        }
        #mac-help strong { color: #fff; }

        #btn-dl { background: var(--main); color: #000; display: none; margin-top: 5px; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body onload="setMode('cam')">

<div id="media-stage">
    <div id="reader"></div>
    <video id="screen-video" autoplay playsinline muted></video>
    <div class="overlay-guide" id="guide-text">Selecciona una fuente</div>
</div>

<div class="controls">
    <div class="btn-group">
        <button id="btn-cam" onclick="setMode('cam')">üì∑ C√ÅMARA</button>
        <button id="btn-screen" onclick="setMode('screen')">üíª VENTANA / PANTALLA</button>
    </div>

    <div id="mac-help">
        <strong>¬øSolo ves Chrome?</strong><br>
        En macOS: <em>Ajustes > Privacidad > Grabaci√≥n de Pantalla > Activa Chrome</em> y reinicia.
    </div>

    <div class="progress-container">
        <div id="bar" class="bar"></div>
    </div>

    <div class="info">
        <div>Bloques: <span id="lbl-parts">0/0</span></div>
        <div>Velocidad: <span id="lbl-speed">0</span> pq/s</div>
    </div>

    <div id="diag-panel">
        <span class="diag-title">‚ö†Ô∏è FALTAN PAQUETES</span>
        <span class="diag-note">Pon esto en el Emisor:</span>
        <span class="diag-data" id="diag-msg">Calculando...</span>
        <button onclick="runDiagnosis()" style="margin-top:5px; background: #443300; border:1px solid #665500;">üîÑ RE-ESCANEAR FALTANTES</button>
    </div>

    <button id="btn-dl" onclick="downloadFile()">GUARDAR ARCHIVO üíæ</button>
</div>

<script>
    let html5QrCode = null;
    let screenStream = null;
    let barcodeDetector = null;
    let loopId = null;

    let session = {
        active: false, total: 0, chunks: [], count: 0, filename: "archivo.bin", 
        packetsSec: 0, missingMode: false
    };

    async function setMode(mode) {
        await stopAll(); // Detener todo antes de cambiar
        
        document.getElementById('btn-cam').className = mode === 'cam' ? 'btn-active' : '';
        document.getElementById('btn-screen').className = mode === 'screen' ? 'btn-active' : '';
        document.getElementById('mac-help').style.display = 'none';

        if (mode === 'cam') {
            document.getElementById('reader').style.display = 'block';
            document.getElementById('guide-text').innerText = "Apunta al c√≥digo QR";
            initCamera();
        } else {
            document.getElementById('screen-video').style.display = 'block';
            document.getElementById('guide-text').innerText = "Elige 'Ventana' en el popup";
            initScreen();
        }
    }

    // --- CORRECCI√ìN 1: stopAll robusto (Evita error 'Scanner not running') ---
    async function stopAll() {
        if(html5QrCode) {
            try {
                // Solo detenemos si est√° escaneando activamente
                if (html5QrCode.isScanning) {
                    await html5QrCode.stop();
                }
                html5QrCode.clear();
            } catch(e) {
                console.warn("Scanner stop warning ignored:", e);
            }
        }
        
        if(screenStream) { 
            try {
                screenStream.getTracks().forEach(t => t.stop());
            } catch(e) {}
            screenStream = null; 
        }
        
        if(loopId) cancelAnimationFrame(loopId);
        
        document.getElementById('reader').style.display = 'none';
        document.getElementById('screen-video').style.display = 'none';
    }

    async function initCamera() {
        html5QrCode = new Html5Qrcode("reader");
        try {
            await html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 30, qrbox: (w,h)=>({width: w*0.8, height: w*0.8}) },
                processData, ()=>{}
            );
        } catch(e) { console.error(e); }
    }

    async function initScreen() {
        if ('BarcodeDetector' in window) {
            barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        } else {
            alert("Navegador sin aceleraci√≥n. Se usar√° CPU (lento).");
        }

        try {
            screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" },
                audio: false
            });
            
            const video = document.getElementById('screen-video');
            video.srcObject = screenStream;

            // Ayuda Mac si se cancela
            screenStream.getVideoTracks()[0].onended = () => {
                if(navigator.platform.toUpperCase().indexOf('MAC') >= 0) {
                    document.getElementById('mac-help').style.display = 'block';
                }
            };

            const scan = async () => {
                if(!screenStream || !screenStream.active) return;
                if (video.readyState === video.HAVE_ENOUGH_DATA && barcodeDetector) {
                    try {
                        const bitmaps = await barcodeDetector.detect(video);
                        bitmaps.forEach(bmp => processData(bmp.rawValue));
                    } catch(e) {}
                }
                loopId = requestAnimationFrame(scan);
            };
            scan();

        } catch(e) { 
            console.log("Error pantalla", e);
            if(navigator.platform.toUpperCase().indexOf('MAC') >= 0) {
                document.getElementById('mac-help').style.display = 'block';
            }
            setMode('cam'); 
        }
    }

    function processData(text) {
        try {
            const data = JSON.parse(text);
            
            // Header
            if (data.t === "H" && !session.active) {
                session.active = true;
                session.total = data.c;
                session.filename = data.n;
                // Creamos el array y lo llenamos de null expl√≠citamente
                session.chunks = new Array(data.c).fill(null);
                document.getElementById('guide-text').innerText = "RECIBIENDO DATOS...";
                updateUI();
                return;
            }
            
            // Payload
            if (session.active && Array.isArray(data)) {
                const idx = data[0];
                const content = data[1];
                
                // Validaci√≥n de integridad b√°sica
                if(idx < session.total && session.chunks[idx] === null) {
                    session.chunks[idx] = content;
                    session.count++;
                    session.packetsSec++;
                    updateUI();
                }
            }
        } catch(e) {}
    }

    function updateUI() {
        const pct = Math.floor((session.count / session.total) * 100);
        document.getElementById('bar').style.width = pct + "%";
        document.getElementById('lbl-parts').innerText = `${session.count} / ${session.total}`;

        if (session.count === session.total && session.total > 0) {
            document.getElementById('btn-dl').style.display = "block";
            document.getElementById('diag-panel').style.display = "none";
            document.getElementById('guide-text').innerText = "‚úÖ COMPLETADO";
            // No detenemos autom√°ticamente para evitar conflictos si llegan paquetes tard√≠os
        }
        
        if (pct > 90 && !session.missingMode && session.count < session.total) {
            document.getElementById('diag-panel').style.display = "block";
            session.missingMode = true;
            runDiagnosis();
        }
    }

    window.runDiagnosis = function() {
        if (!session.active) return;
        let firstMissing = -1, lastMissing = -1;
        // Buscar huecos
        for (let i = 0; i < session.total; i++) {
            if (session.chunks[i] === null) {
                if (firstMissing === -1) firstMissing = i;
                lastMissing = i;
            }
        }
        const msgEl = document.getElementById('diag-msg');
        if (firstMissing === -1) {
            msgEl.innerText = "¬°Completo!";
            document.getElementById('btn-dl').style.display = "block";
        } else {
            msgEl.innerHTML = `DESDE: <b style="color:#f00">${firstMissing}</b> | HASTA: <b style="color:#f00">${lastMissing}</b>`;
            if(navigator.vibrate) navigator.vibrate(200);
        }
    }

    // --- CORRECCI√ìN 2: Descarga Segura (Evita error 'atob') ---
    window.downloadFile = function() {
        // 1. Verificaci√≥n final de integridad
        if(session.count !== session.total) {
            alert("Error: A√∫n faltan paquetes. Revisa el diagn√≥stico.");
            runDiagnosis();
            return;
        }

        try {
            // 2. Reconstrucci√≥n con manejo de errores
            const b64Data = session.chunks.join('');
            
            // Limpieza preventiva (quitar espacios si los hubiera)
            const cleanB64 = b64Data.trim();
            
            const byteCharacters = atob(cleanB64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            
            const blob = new Blob([byteArray], {type: "application/octet-stream"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = session.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Detener c√°mara despu√©s de descarga exitosa
            setTimeout(() => stopAll(), 500);

        } catch (e) {
            console.error(e);
            alert("ERROR CR√çTICO: El archivo reconstruido est√° corrupto (Error Base64). Intenta re-escanear las partes faltantes.");
            // Forzar diagn√≥stico
            runDiagnosis();
        }
    }

    setInterval(() => {
        document.getElementById('lbl-speed').innerText = session.packetsSec;
        if (session.active && session.packetsSec === 0 && session.count > 0 && session.count < session.total) {
            document.getElementById('diag-panel').style.display = "block";
            runDiagnosis();
        }
        session.packetsSec = 0;
    }, 1000);
</script>
</body>
</html>

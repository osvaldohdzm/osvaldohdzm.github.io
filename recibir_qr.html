<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Receptor V10 - Validador</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --bg: #050505; --panel: #111; --main: #00ff41; --err: #ff3333; }
        body { background: var(--bg); color: #fff; font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #stage { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        #vid { position: absolute; opacity: 0; }
        #canvas { width: 100%; height: 100%; object-fit: contain; }
        .scope { position: absolute; width: 300px; height: 300px; border: 2px solid var(--err); z-index: 10; pointer-events: none; }
        .scope::after { content: "üéØ SCAN"; color: var(--err); font-weight: bold; position: absolute; bottom: -20px; width: 100%; text-align: center; }

        .dash { background: var(--panel); border-top: 1px solid #333; padding: 10px; z-index: 20; }
        .meta { display: grid; grid-template-columns: 1fr auto; background: #222; padding: 5px; font-size: 0.8rem; margin-bottom: 5px; }
        .hash { grid-column: span 2; color: #aaa; font-size: 0.7rem; }
        
        .prog { height: 10px; background: #333; width: 100%; margin: 5px 0; }
        .fill { height: 100%; width: 0%; background: var(--main); }
        
        .strat { background: #330000; color: #fff; padding: 5px; text-align: center; font-size: 0.9rem; display: none; border: 1px solid var(--err); }
        
        button { width: 100%; padding: 12px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; font-weight: bold; margin-top: 5px; }
        button.dl { background: var(--main); color: #000; display: none; }
    </style>
</head>
<body onload="init()">

<div id="stage">
    <div id="reader" style="display:none; width:100%; height:100%;"></div>
    <video id="vid" autoplay playsinline muted></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div class="scope" id="scope"></div>
</div>

<div class="dash">
    <div class="meta">
        <div id="lbl-name">Esperando Header...</div>
        <div id="lbl-cnt">0/0</div>
        <div class="hash" id="lbl-hash">SHA256: -</div>
    </div>
    
    <div class="prog"><div class="fill" id="bar"></div></div>
    <div id="lbl-spd" style="font-size:0.7rem; color:#888; text-align:right;">0 pq/s</div>

    <div class="strat" id="strat-box">
        ‚ö†Ô∏è FALTAN PAQUETES: <span id="strat-txt">-</span>
    </div>

    <div style="display:flex; gap:5px;">
        <button onclick="setMode('cam')">üì∑ CAM</button>
        <button onclick="setMode('screen')">üíª PANTALLA</button>
    </div>
    <button id="btn-dl" class="dl" onclick="verifyAndDownload()">VALIDANDO INTEGRIDAD...</button>
</div>

<script>
    let sys = { mode: 'cam', session: { active: false, chunks: [], count: 0, total: 0, hash: null } };
    let detector, stream, loop, qr;

    function init() { setMode('cam'); }

    async function setMode(m) {
        stop();
        sys.mode = m;
        document.getElementById('scope').style.display = m === 'screen' ? 'block' : 'none';
        document.getElementById('canvas').style.display = m === 'screen' ? 'block' : 'none';
        
        if(m === 'cam') {
            document.getElementById('reader').style.display = 'block';
            qr = new Html5Qrcode("reader");
            qr.start({ facingMode: "environment" }, { fps: 30, qrbox: 250 }, onData, ()=>{});
        } else {
            if(!('BarcodeDetector' in window)) return alert("Usa Chrome/Edge");
            detector = new BarcodeDetector({ formats: ['qr_code'] });
            try {
                stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "never" }, audio: false });
                document.getElementById('vid').srcObject = stream;
                loopScreen();
            } catch(e) { setMode('cam'); }
        }
    }

    function stop() {
        if(qr?.isScanning) qr.stop().catch(()=>{});
        if(stream) stream.getTracks().forEach(t => t.stop());
        cancelAnimationFrame(loop);
        document.getElementById('reader').style.display = 'none';
    }

    async function loopScreen() {
        const v = document.getElementById('vid');
        const c = document.getElementById('canvas');
        const ctx = c.getContext('2d', {willReadFrequently: true});
        
        if(v.readyState === 4 && stream.active) {
            // Sniper Zoom
            const s = 3200;
            c.width = s; c.height = s;
            ctx.drawImage(v, (v.videoWidth/2)-(s/2), (v.videoHeight/2)-(s/2), s, s, 0, 0, s, s);
            try {
                const b = await detector.detect(c);
                b.forEach(x => onData(x.rawValue));
            } catch(e){}
        }
        loop = requestAnimationFrame(loopScreen);
    }

    function onData(txt) {
        try {
            const d = JSON.parse(txt);
            if(d.t === "H" && !sys.session.active) {
                sys.session = { active: true, total: d.c, name: d.n, hash: d.h, chunks: new Array(d.c).fill(null), count: 0 };
                document.getElementById('lbl-name').innerText = d.n;
                document.getElementById('lbl-hash').innerText = "ESPERADO: " + (d.h || "SIN FIRMA");
                return;
            }
            if(sys.session.active && Array.isArray(d)) {
                if(sys.session.chunks[d[0]] === null) {
                    sys.session.chunks[d[0]] = d[1];
                    sys.session.count++;
                    updateUI();
                }
            }
        } catch(e){}
    }

    function updateUI() {
        const s = sys.session;
        const pct = Math.floor((s.count/s.total)*100);
        document.getElementById('bar').style.width = pct + "%";
        document.getElementById('lbl-cnt').innerText = `${s.count}/${s.total}`;
        
        if(s.count === s.total) {
            document.getElementById('strat-box').style.display = 'none';
            const btn = document.getElementById('btn-dl');
            btn.style.display = 'block';
            btn.innerText = "VERIFICAR Y GUARDAR üíæ";
            stop();
        } else if (pct > 80 && s.count % 10 === 0) {
            calcStrategy();
        }
    }

    function calcStrategy() {
        const s = sys.session;
        let missing = [];
        for(let i=0; i<s.total; i++) if(s.chunks[i] === null) missing.push(i);
        if(missing.length > 0) {
            // Algoritmo simple de clustering
            let range = 200;
            let bestStart = 0;
            let maxMiss = 0;
            for(let i=0; i<s.total; i+=range) {
                let cnt = 0;
                for(let j=i; j<Math.min(i+range, s.total); j++) if(s.chunks[j] === null) cnt++;
                if(cnt > maxMiss) { maxMiss = cnt; bestStart = i; }
            }
            document.getElementById('strat-box').style.display = 'block';
            document.getElementById('strat-txt').innerHTML = `RANGO: ${bestStart} - ${bestStart+range}`;
        }
    }

    async function verifyAndDownload() {
        const s = sys.session;
        const btn = document.getElementById('btn-dl');
        btn.innerText = "‚è≥ CALCULANDO HASH...";
        
        try {
            // 1. Reconstruir
            const b64 = s.chunks.join('');
            const bin = atob(b64);
            const len = bin.length;
            const arr = new Uint8Array(len);
            for(let i=0; i<len; i++) arr[i] = bin.charCodeAt(i);

            // 2. Calcular Hash del resultado
            const hashBuf = await crypto.subtle.digest('SHA-256', arr);
            const hashArr = Array.from(new Uint8Array(hashBuf));
            const calcHash = hashArr.map(b => b.toString(16).padStart(2, '0')).join('');
            
            // 3. Comparar (Primeros 16 chars si el header vino truncado, o full si coincide)
            // El emisor V5 env√≠a 16 chars. 
            const expected = s.hash; 
            const calculatedPartial = calcHash.substring(0, expected.length);

            if(calculatedPartial === expected) {
                btn.style.background = "#00ff41";
                btn.innerText = "‚úÖ VALIDADO - DESCARGANDO";
                const blob = new Blob([arr], {type: "application/octet-stream"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = s.name;
                a.click();
            } else {
                btn.style.background = "red";
                btn.innerText = "‚ùå ERROR DE HASH (CORRUPTO)";
                alert(`Error de Integridad!\nEsperado: ${expected}\nCalculado: ${calculatedPartial}`);
            }

        } catch(e) {
            alert("Error fatal: " + e);
        }
    }
</script>
</body>
</html>
